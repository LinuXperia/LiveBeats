<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Live Beats | g200kg Music &amp; Software</title>
</head>
<body onload="Init()" style="background:#000">
<script src="https://skyway.io/dist/0.3/peer.min.js"></script>

<script type="text/javascript" src="./vj_txt.js"></script>
<script type="text/javascript" src="./vj_wavegl.js"></script>
<script type="text/javascript" src="./vj_matrix.js"></script>
<script type="text/javascript" src="./vj_camgl.js"></script>
<script type="text/javascript" src="./vj_dropgl.js"></script>
<!--<script type="text/javascript" src="./vj_beatstep.js"></script>-->
<script type="text/javascript">

//var internalResoX=800;
//var internalResoY=600;
var internalResoX=window.innerWidth;
var internalResoY=window.innerHeight;

var buffers = [];
var loadidx=0;
var req = new XMLHttpRequest();
var wavdat=new Uint8Array(512);
var freqdat=new Uint8Array(256);
var cnt=0;
var lfo1=0;
var lfo2=0;
var lfo4=0;
var lfo8=0;
var lfo16=0;
var lfo32=0;
var lfo48=0;
var lfo64=0;
var sh1=0;
var sh2=0;
var sh4=0;
var sh8=0;
var sh16=0;
var rand1=rand2=rand4=0;
var lev=0;
var bd1="crrrcrrrcrrrcrcr";
var sd1="rrrrcrrrrrrrcrrr";
var hh1="crcrcrcrcrcrcrcc";
var s0="rrrrrrrrrrrrrrrr";
var s1="crrrcrrrcrrrcrrr";
var s2="aarrddrrcrcrerrr";
var s3="gagarrrrddrreerr";
var s4="grrrddeegrrrddcc";
var s5="errrcrerarddcrrr";
var s6="crrrargrdcgrardr";
var s7="ererggeecdrcgrrr";
var s8="errrarrrgrrrerfr";
var s9="ddddrrrrggggdddd";
var s10="crrrcrrrcrrrcrrr";
var s11="aaaarrrrrrrrrrrr";
var s12="aaaarrrrddddrrrr";
var s13="ddggrraaaaggdrdr";
var s14="arrrggrrgrrreerr";
var s15="crargrcrarrrdrrr";
var s16="rrrrgrggrrrreree";
var s17="crrrdrerrrcrdrer";
var s18="eeeerrddeeeerrgg";
var s19="arrrrrrrrrrrrrrr";
var s20="cdegacdegeadcged";
var s21="dadcgagcacdegaed";
var s23="grcdgrcdarrrabab";
var s24="eergeergaardaard";
var tick=0;
var mouse={"px":0,"py":0,"pz":0};
var nextTime=0;

var master=null;
var o1,o2,o3,o4,o5,o6,o7,o8;
var delay;
var video=null;
var eff=null;
var elEff=null;
var scrWidth=100;
var scrHeight=100;

var list=[];
var ir=[];
var shot=[];
var plugins=[];
var pluginsparam=[];
var midicb=[];
var peer;
var peerid=null;
var peerconn=null;

var fn=[
	"wav.type=0;wav.fill=0;wav.effr=.9;wav.effx=0;wav.effy=0;wav.effz=1.05",
	"wav.type=1;wav.fill=0;wav.effr=.9;wav.effx=0;wav.effy=10;wav.effz=1",
	"wav.type=2;wav.fill=0;wav.effr=.9;wav.effx=0;wav.effy=0;wav.effz=1.05",
	"wav.type=2;wav.fill=1;wav.effr=.9;wav.effx=0;wav.effy=0;wav.effz=1.05",
	"cam.a=0;cam.v=0;wav.a=0",
	"",
	"bdo.v=0;sdo.v=0;hho.v=0;cam.v=0",
	"bdo.v=.5;sdo.v=.5;hho.v=.5",
	"",
	"",
	"",
	"",
];

function Trigger(instrument,accent,when) {
	if(accent==0)
		return;
	var src=audioctx.createBufferSource();
	src.buffer=buffers[instrument];
	var g=audioctx.createGain();
	g.gain.value=0.8;
	src.connect(g);
	g.connect(out);
	src.start(when);
}
function DragOver(ev) {
	ev.stopPropagation();
	ev.preventDefault();
	ev.dataTransfer.dropEffect="copy";
}
function _LoadPlugin(script,name,layer) {
	var plug={"script":script,"name":name};
	eval("plug.obj=new "+script+"({'w':"+internalResoX+",'h':"+internalResoY+",'cmds':cmds,'wavedat':wavdat,'freqdat':freqdat,'video':video.video,'audioctx':audioctx,'dest':master.out,'senddest':delay.Dly})");
	InitPlugin(plug,layer);
	return plug;
}
function NamePlugin(name) {
	var n=name.split("=");
	if(n.length!=2)
		return "usage: name oldName=newName\n";
	for(i=0;i<plugins.length;++i) {
		if(plugins[i].name==n[0]) {
			plugins[i].name=n[1];
			return "'"+n[0]+"' is named '"+n[1]+"'\n";
		}
	}
	return "plugin '"+n[0]+"' is not found.\n";
}
function LoadPlugin(name) {
	var n=name.split("=");
	if(n.length!=2)
		return "usage: load Name=ScriptName\n";
	_LoadPlugin(n[1],n[0],"base");
	return "plugin '"+n[1]+"' is loaded as '"+n[0]+"'\n";
}
function DeletePlugin(name) {
	var i;
	for(i=0;i<plugins.length;++i) {
		if(plugins[i].name==name)
			break;
	}
	if(i==plugins.length) {
		return "plugin '"+name+"' is not found.\n";
	}
	var plug=plugins[i];
	document.getElementById("base").removeChild(plug.obj.elem);
	plugins.splice(i,1);
	pluginsparam.splice(i,1);
	return "plugin '"+name+"' is deleted.\n";
}
function InitPlugin(plug,layer) {
	plug.obj.elem.style.position="absolute";
	plug.obj.elem.style.left="0px";
	plug.obj.elem.style.top="0px";
	plugins.push(plug);
	pluginsparam.push({});
	var p={
		"a":{"value":1,"min":0,"max":1},
		"blur":{"value":0,"min":0,"max":10},
		"rot":{"value":0,"min":-360,"max":360},
		"hue":{"value":0,"min":-360,"max":360},
		"w":{"value":1,"min":0,"max":1},
		"h":{"value":1,"min":0,"max":1},
		"x":{"value":.5,"min":0,"max":1},
		"y":{"value":.5,"min":0,"max":1},
		"z":{"value":1,"min":0,"max":2},
	};
	for(var j in plug.obj.param)
		p[j]=plug.obj.param[j];
	plug.obj.param=p;
	document.getElementById(layer).appendChild(plug.obj.elem);
	cmds.message("plugin '"+plug.script+"' is loaded as:"+plug.name);
	if(plug.obj.onmidimessage){
		midicb.push({func:plug.obj.onmidimessage,plug:plug.obj});
	}
}
function FileDrop(ev) {
	ev.stopPropagation();
	ev.preventDefault();
	var files=ev.dataTransfer.files;
	var name=files[0].name;
	if(name.indexOf("vj_")==0 && name.lastIndexOf(".js")==name.length-3) {
		name=name.substr(0,name.length-3);
		var reader=new FileReader();
		reader.onload=function(ev) {
			eval(ev.target.result);
			_LoadPlugin(this.name,"plug"+plugins.length,"base");
		};
		reader.name=name;
		reader.readAsText(files[0]);
	}
}
function animInterval(timestamp) {
	var layout=false;
	if(master.run==0)
		return;
//	Interval();
	if(timestamp-lastTime>50) {
		lastTime=timestamp;
		layout=true;
	}
	else {
//		window.requestAnimationFrame(animInterval);
		return;
	}
//	Interval();
	if(++master.tccnt>=10)
		document.getElementById("timecode").innerHTML=Timecode(audioctx.currentTime);
	master.ana.getByteTimeDomainData(wavdat);
	master.ana.getByteFrequencyData(freqdat);
	for(var i=0,e=plugins.length;i<e;++i) {
		var plug=plugins[i].obj;
		var plugparam=pluginsparam[i];
		plug.anim(timestamp);
		for(var j in plugparam) {
			if(plug.param[j]) {
				if(isNaN(plug.param[j].value))
					plug.param[j].value=0;
				switch(plug.param[j].type) {
				case "string":
					plug.param[j].value=streval(plugparam[j]);
					break;
				case "int":
					plug.param[j].value=numeval(plugparam[j])|0;
					break;
				case "double":
				default:
					var v=numeval(plugparam[j]);
					var d=v-plug.param[j].value;
					if(Math.abs(d)<1e-10)
						plug.param[j].value=v;
					else
						plug.param[j].value+=d*.2;
					break;
				}
			}
		}
		if(layout) {
			var w=plug.param.w.value*plug.param.z.value;
			var h=plug.param.h.value*plug.param.z.value;
			plug.elem.style.left=((scrWidth*plug.param.x.value-scrWidth*w*.5)|0)+"px";
			plug.elem.style.top=((scrHeight*plug.param.y.value-scrHeight*h*.5)|0)+"px";
			plug.elem.style.width=((scrWidth*w)|0)+"px";
			plug.elem.style.height=((scrHeight*h)|0)+"px";
			plug.elem.style.opacity=plug.param.a.value;
/*			plug.elem.style.WebkitFilter="blur("+(plug.param.blur.value|0)+"px)";
			plug.elem.style.WebkitFilter=plug.elem.style.mozFilter="hue-rotate("+plug.param.hue.value+"deg)";
*/			plug.elem.style.transform="rotate("+plug.param.rot.value+"deg)";
		}
	}
//	window.requestAnimationFrame(animInterval);
}
function PeerStart(){
	if(peerconn)
		peerconn.send("start");
}
function PeerSend(s){
	if(peerconn){
		peerconn.send(s);
	}
}
function Init() {
	peer = new Peer("master",{key: '126ad558-f09f-46e6-9e5d-5f910bbaa047'});
	peer.on('open',function(id){
		peerid=id;
		console.log("peer open:"+id);
		peerconn=peer.connect('slave');
		if(peerconn){
			console.log("peer connect");
		}
		console.log("peerconn:"+peerconn);
	});
	peer.on('connection',function(conn){
		peerconn=conn;
		console.log("event peer connection");
	});
	window.AudioContext=window.webkitAudioContext||window.AudioContext;
	audioctx=new AudioContext();
	midi=new Midi();
	master=new Master();
	out=master.out;
	run=1;
	delay=new Delay();
//	noise=new Noise();
	o1=new OSC(110,0.4,1,out);
	o2=new OSC(440,0.3,1,out);
	o3=new OSC(440,0.3,1,out);
	o4=new OSC(880,0.3,1,out);
	o5=new OSC(110,0.3,1,out);
	o6=new OSC(440,0.3,1,out);
	o7=new OSC(440,0.3,1,out);
	o8=new OSC(880,0.3,1,out);
	bdo=new FMO(115,.5,.8,.2,0,  451,.5,2670,.02,0,  131,1,1303,.1,0, .5);
	sdo=new FMO(213,1,.8,.1,0, 723,1,2912,.6,0, 140,1,800,.1,0,.3);
	hho=new FMO(2233,1,.5,.03,0, 423,1,3120,.07,2, 552,1,1800,.02,1,.7);
	cyo=new FMO(2612,1,.4,.4,0, 1826,1,4219,5,2, 3897,1,1401,1,2,.4);
//	bdo=new BOSC(0,2.0);
//	sdo=new BOSC(1,2.0);
//	hho=new BOSC(2,0.8);
	cmds=new Cmds();
	video=new Video();
	Resize();
	window.addEventListener("resize",Resize);
	window.document.addEventListener("keypress",KeyPress);
	window.document.addEventListener("keydown",KeyDown);
	window.document.addEventListener("mousemove",MouseEvent);
	window.document.addEventListener("mousedown",MouseEvent);
	window.document.addEventListener("mouseup",MouseEvent);
	Reset();
	cmds.message("LiveBeats initialized.");
	cmds.message("");
	if(window.xhrreqerr) {
		cmds.message("IR files cannot be loaded, 'master.ir' is desabled.");
		cmds.message("  May be connect with 'file:///'?");
		cmds.message("  Should be placed on WebServer and connect with http://");
	}
	lastTime=0;
	document.addEventListener("dragover",DragOver,false);
	document.addEventListener("drop",FileDrop,false);

	cam=_LoadPlugin("vj_cam","cam","base");
	cam.obj.param.a.value=0;
	drop=_LoadPlugin("vj_drop","drop","base");
	drop.obj.param.a.value=0;
	mat=_LoadPlugin("vj_matrix","mat","base");
	mat.obj.param.a.value=0;
	_LoadPlugin("vj_wave","wav","base");
	_LoadPlugin("vj_txt","txt","topmost");

//	setTimeout(function(){window.requestAnimationFrame(animInterval);},1000);
//	setInterval(animInterval);
	setInterval(Interval,30);
}
function Resize() {
	scrWidth=document.body.clientWidth;
	scrHeight=window.innerHeight-20;
	var b=document.getElementById("base");
	b.style.width=scrWidth+"px";
	b.style.height=scrHeight+"px";
	b=document.getElementById("topmost");
	b.style.width=scrWidth+"px";
	b.style.height=scrHeight+"px";
//	cam.layout();
}
function MouseEvent(ev) {
	mouse.px=ev.x/scrWidth;
	mouse.py=1-ev.y/scrHeight;
	mouse.pz=ev.which;
}
function KeyDown(ev) {
	switch(ev.keyCode) {
	case 8:
		cmds.key(8);
		ev.preventDefault();
		ev.stopPropagation();
		return false;
	case 13:
		cmds.key(13);
		ev.preventDefault();
		return false;
	case 37:  //left
		cmds.key("l");
		ev.preventDefault();
		return false;
	case 38:  //up
		cmds.key("u");
		ev.preventDefault();
		return false;
	case 39:  //right
		cmds.key("r");
		ev.preventDefault();
		return false;
	case 40:  //down
		cmds.key("d");
		ev.preventDefault();
		return false;
	case 112:  //f1
		cmds.key("f1");
		ev.preventDefault();
		return false;
	case 113:  //f2
		cmds.key("f2");
		ev.preventDefault();
		return false;
	case 114:  //f3
		cmds.key("f3");
		ev.preventDefault();
		return false;
	case 115:  //f4
		cmds.key("f4");
		ev.preventDefault();
		return false;
	case 116:  //f5
		cmds.key("f5");
		ev.preventDefault();
		return false;
	case 117:  //f6
		cmds.key("f6");
		ev.preventDefault();
		return false;
	case 118:  //f7
		cmds.key("f7");
		ev.preventDefault();
		return false;
	case 119:  //f8
		cmds.key("f8");
		ev.preventDefault();
		return false;
	case 120:  //f9
		cmds.key("f9");
		ev.preventDefault();
		return false;
	case 121:  //f10
		cmds.key("f10");
		ev.preventDefault();
		return false;
	case 122:  //f11
		cmds.key("f11");
		ev.preventDefault();
		return false;
	case 123:  //f12
		break;
	}
}
function KeyPress(ev) {
	cmds.key(ev.charCode);
	ev.preventDefault();
	ev.stopPropagation();
	return false;
}
function Reset() {
	o1.step=o2.step=o3.step=o4.step=o5.step=o6.step=o7.step=o8.step=0;
//	o1.step=o2.step=o3.step=o4.step=o5.step=o6.step=0;
	bdo.step=sdo.step=hho.step=cyo.step=0;
//	bdo.step=sdo.step=hho.step=0;
	cnt=0;
	lfo1=lfo2=lfo4=lfo8=lfo16=lfo32=lfo48=lfo64=0;
}
function Enter(s) {
	var r="";
	if(s.indexOf("//")==0)
		return "";
	var n=0;
	for(var i=s.length-1;i>=0;--i)
		if(s[i]=="\"")
			++n;
	if(n&1)
		s+="\"";
	var ss=s.split(";");
	for(var idx=0;idx<ss.length;++idx) {
		s=ss[idx];
		r+=Enter1(s);
	}
	return r;
}
function oscdesc(o,nam) {
	var r;
	r=nam+".s (note):"+o.s+"\n";
	r+=nam+".g (gate):"+o.g+"\n";
	r+=nam+".v (volume):"+o.v+"\n";
	r+=nam+".f (freq):"+o.f+"\n";
	r+=nam+".c (cutoff):"+o.c+"\n";
	r+=nam+".q (Q):"+o.q+"\n";
	r+=nam+".delay:"+o.delay+"\n";
	r+=nam+".pan:"+o.pan+"\n";
	r+=nam+".out:"+o.out+"\n";
	return r;
}
function fmodesc(o,nam) {
	var r;
	r=nam+".s (step):"+o.s+"\n";
	r+=nam+".v (volume):"+o.v+"\n";
	r+=nam+".pan:"+o.pan;
	return r;
}
function Parse0(s) {
	function Parse1(l,r) {
		var o=null;
		var fmo=null;
		for(var i=0;i<plugins.length;++i) {
			var p=plugins[i];
			var pparam=pluginsparam[i];
			if(l.indexOf(p.name+".")==0) {
				var pname=l.substr(p.name.length+1);
				pparam[pname]=r;
			}
		}
		if(l.indexOf("bdo.")==0)
			fmo=bdo;
		else if(l.indexOf("sdo.")==0)
			fmo=sdo;
		else if(l.indexOf("hho.")==0)
			fmo=hho;
		else if(l.indexOf("cyo.")==0)
			fmo=cyo;
		if(fmo) {
			switch(l.substr(4)) {
			case "s": fmo.s=right; break;
			case "s+": fmo.s=streval(fmo.s)+streval(right); break;
			case "v": fmo.v=right; break;
			case "pan": fmo.pan=right; break;
			case "f1": fmo.f1=right; break;
			case "f2": fmo.f2=right; break;
			case "f3": fmo.f3=right; break;
			case "p1": fmo.p1=right; break;
			case "p2": fmo.p2=right; break;
			case "p3": fmo.p3=right; break;
			case "v1": fmo.v1=right; break;
			case "v2": fmo.v2=right; break;
			case "v3": fmo.v3=right; break;
			case "r1": fmo.r1=right; break;
			case "r2": fmo.r2=right; break;
			case "r3": fmo.r3=right; break;
			default: return "Property not found";
			}
			return null;
		}
		if(l[0]=="o" && l[2]==".") {
			switch(l[1]) {
			case "1": o=o1; break;
			case "2": o=o2; break;
			case "3": o=o3; break;
			case "4": o=o4; break;
			case "5": o=o5; break;
			case "6": o=o6; break;
			case "7": o=o7; break;
			case "8": o=o8; break;
			}
			if(o) {
				switch(l.substr(3)) {
				case "s": o.s=right; break;
				case "s+": o.s=streval(o.s)+streval(right); break;
				case "g": o.g=right; break;
				case "g+": o.g=streval(o.g)+streval(right); break;
				case "f": o.f=right; break;
				case "v": o.v=right; break;
				case "c": o.c=right; break;
				case "q": o.q=right; break;
				case "type": o.type=right; break;
				case "delay": o.delay=right; break;
				case "pan": o.pan=right; break;
				case "out": o.out=right; break;
				case "d": o.d=right; break;
				default: return "Property not found";
				}
				return null;
			}
		}
		switch(l) {
		case "video.src": video.Switch(numeval(r)); break;
		case "peer.send": PeerSend(r); break;
		case "master.v": master.v=r; break;
		case "master.g": master.g=r; break;
		case "master.tempo": master.tempo=r; PeerSend("tempo:"+r); break;
		case "master.rev": master.rev=r; break;
		case "master.ir": master.ir=numeval(r);
			if(master.ir>=1)
				master.conv.buffer=ir[master.ir-1].data;
			break;
		case "master.run": master.run=r; break;
		case "delay.t": delay.t=r; break;
		case "delay.fb": delay.fb=r; break;
		case "txt.a": cmds.a=r; break;
		case "txt.w": cmds.w=r; break;
		case "txt.h": cmds.h=r; break;
		case "txt.x": cmds.x=r; break;
		case "txt.y": cmds.y=r; break;
		case "txt.z": cmds.z=r; break;
		case "txt.rot": cmds.rot=r; break;
		case "txt.hue": cmds.hue=r; break;
		case "txt.eff": cmds.eff=r; break;
		case "txt.col": cmds.col=r; break;
		case "txt.bcol": cmds.bcol=r; break;
/*		case "cam.v": cam.v=r; break;
		case "cam.q": cam.q=r; break;
		case "cam.c": cam.c=r; break;
		case "cam.f": cam.f=r; break;
		case "cam.g": cam.g=r; break;
		case "cam.delay": cam.delay=r; break;
		case "cam.porta": cam.porta=r; break;
		case "cam.scale": cam.scale=r; cam.notes=Mml(cam.scale); break;
		case "cam.midi": cam.midi=r; break;
		case "cam.a": cam.a=r; break;
		case "cam.w": cam.w=r; break;
		case "cam.h": cam.h=r; break;
		case "cam.x": cam.x=r; break;
		case "cam.y": cam.y=r; break;
		case "cam.z": cam.z=r; break;
		case "cam.rot": cam.rot=r; break;
		case "cam.hue": cam.hue=r; break;
		case "cam.effv": cam.effv=r; break;
		case "cam.effk": cam.effk=r; break;
		case "cam.effb": cam.effb=r; break;
		case "cam.effl": cam.effl=r; break;
		case "cam.effm": cam.effm=r; break;
*/		default: return "Object not found";
		}
		return null;
	}
	var v=s.split("=");
	var right=v[v.length-1];
	var r;
	for(var i=v.length-2;i>=0;--i) {
		r=Parse1(v[i],right);
		if(r)
			break;
	}
	if(r)
		return r;
	else
		return right;
}
function Parse(str) {
	function isspc(p) {
		if(str[p]==" "||p>=str.length)
			return true;
		return false;
	}
	function skip(p) {
		while(p<str.length&&isspc(p))
			++p;
		return p;
	}
	function test(p,s) {
		if(str.indexOf(s,p)==p&&isspc(p+s.length))
			return true;
		return false;
	}
	var p=0;
	p=skip(p);
	if(test(p,"reload")){
		location.href=location.href;
	}
	if(test(p,"clear")) {
		cmds.log.length=0;
		return "";
	}
	if(test(p,"print")) {
		var s;
		p=skip(p+5);
		s=replaceplugin(str.substr(p));
		try {
			s=eval(s)+"\n";
		} catch(e) {s="Undefined\n";}
		return s;
	}
	if(test(p,"name")) {
		p=skip(p+4);
		return NamePlugin(str.substr(p));
	}
	if(test(p,"del")) {
		p=skip(p+3);
		return DeletePlugin(str.substr(p));
	}
	if(test(p,"load")) {
		p=skip(p+4);
		return LoadPlugin(str.substr(p));
	}
	if(test(p,"list")) {
		var r="";
		p=skip(p+4);
		if(test(p,"plugins")) {
			for(var i=0;i<plugins.length;++i) {
				r+=plugins[i].name+":"+plugins[i].script+"\n";
			}
			return r;
		}
		for(var i=0;i<plugins.length;++i) {
			if(test(p,plugins[i].name)) {
				r+=plugins[i].name+":\n";
				for(var j in plugins[i].obj.param) {
					r+=" "+j+":"+plugins[i].obj.param[j].value+"\n";
				}
				return r;
			}
		}
		if(test(p,"ir")) {
			for(var i=0;i<ir.length;++i) {
				r+=(i+1)+":"+ir[i].name+"\n";
			}
			return r;
		}
		if(test(p,"midi")) {
			for(var i=0;i<midioutputs.length;++i) {
				r+=(i+1)+":"+midioutputs[i].name+"\n";
			}
			return r;
		}
		if(test(p,"osc")) {
			r="o1.s:"+o1.s;
			r+="\no2.s:"+o2.s;
			r+="\no3.s:"+o3.s;
			r+="\no4.s:"+o4.s;
			r+="\no5.s:"+o5.s;
			r+="\no6.s:"+o6.s;
			r+="\no7.s:"+o7.s;
			r+="\no8.s:"+o8.s;
			r+="\n";
			return r;
		}
		if(test(p,"fmo")) {
			r="cyo.s:"+cyo.s;
			r+="\nhho.s:"+hho.s;
			r+="\nsdo.s:"+sdo.s;
			r+="\nbdo.s:"+bdo.s+"\n";
			return r;
		}
		if(test(p,"master")) {
			r="master.v (volume):"+master.v+"\n";
			r+="master.g (gate):"+master.g+"\n";
			r+="master.tempo:"+master.tempo+"\n";
			r+="master.rev:"+master.rev+"\n";
			r+="master.ir:"+master.ir+"\n";
			return r;
		}
		if(test(p,"delay")) {
			r="delay.t (time):"+delay.t+"\n";
			r+="delay.fb (feedback):"+delay.fb+"\n";
			return r;
		}
		if(test(p,"o1"))
			return oscdesc(o1,"o1");
		if(test(p,"o2"))
			return oscdesc(o2,"o2");
		if(test(p,"o3"))
			return oscdesc(o3,"o3");
		if(test(p,"o4"))
			return oscdesc(o4,"o4");
		if(test(p,"o5"))
			return oscdesc(o5,"o5");
		if(test(p,"o6"))
			return oscdesc(o6,"o6");
		if(test(p,"o7"))
			return oscdesc(o7,"o7");
		if(test(p,"o8"))
			return oscdesc(o8,"o8");
		if(test(p,"bdo"))
			return fmodesc(bdo,"bdo");
		if(test(p,"sdo"))
			return fmodesc(sdo,"sdo");
		if(test(p,"hho"))
			return fmodesc(hho,"hho");
		if(test(p,"cyo"))
			return fmodesc(cyo,"cyo");
		r="";
		r+="--builtin--\n";
		r+="master, delay\n";
		r+="osc:o1 o2 o3 o4 o5 o6 o7 o8\n";
		r+="fmo:bdo sdo hho cyo\n";
		r+="--variables--\ns0-s24:pre-defined sequence\ntick:currentTick\nlev:currentLevel\nsh8/16/32/64: S&H/(n)tick\n";
		r+="lfo8/16/32/64: LFO (n)tick\n";
		r+="--functions--\nhue(h), hsv(h,s,v): for colorString\nlfo(n): (n)tickLFO\n";
		r+="--plugins--\ncam,wav,mat,txt\n";
		return r;
	}
	return null;
}
function Enter1(s) {
	var v=Parse(s);
	if(v!==null)
		return v;
	return Parse0(s);
}
function Mml(s) {
	function GetN(def) {
		var v=0;
		while(s[p]>="0"&&s[p]<="9") {
			v=v*10+s[p];
			++p;
		}
		if(v==0)
			return def;
		return v;
	}
	function GetLen(def) {
		var l=16/GetN(def);
		var l2=l;
		while(s[p]==".") {
			++p;
			l2/=2;
			l+=l2;
		}
		return l;
	}
	function Shift(n) {
		for(;;) {
			switch(s[p]) {
			case "+": case "#":
				++p;
				++n;
				break;
			case "-":
				++p;
				--n;
			default:
				return n;
			}
		}
	}
	var r=[];
	var len=s.length;
	var p=0;
	var n=0;
	var o=4;
	var l=0;
	var defl=16;
	while(p<len) {
		l=0;
		switch(s[p]) {
		case ">":
			++p;
			--o;
			break;
		case "<":
			++p;
			++o;
			break;
		case "O": case "o":
			++p;
			o=GetN(4);
			break;
		case "L": case "l":
			++p;
			defl=GetN(16);
			break;
		case "R": case "r":
			++p;
			n=0;
			l=GetLen(defl);
			break;
		case "C": case "c":
			++p;
			n=Shift(o*12);
			l=GetLen(defl);
			break;
		case "D": case "d":
			++p;
			n=Shift(o*12+2);
			l=GetLen(defl);
			break;
		case "E": case "e":
			++p;
			n=Shift(o*12+4);
			l=GetLen(defl);
			break;
		case "F": case "f":
			++p;
			n=Shift(o*12+5);
			l=GetLen(defl);
			break;
		case "G": case "g":
			++p;
			n=Shift(o*12+7);
			l=GetLen(defl);
			break;
		case "A": case "a":
			++p;
			n=Shift(o*12+9);
			l=GetLen(defl);
			break;
		case "B": case "b":
			++p;
			n=Shift(o*12+11);
			l=GetLen(defl);
			break;
		default:
			++p;
		}
		for(var i=0;i<l;++i)
			r.push(n);
	}
	if(r.length==0)
		return [0];
	return r;
}
function Timecode(t) {
	var hh=(t/3600)|0;
	t-=hh*3600;
	var mm=(t/60)|0;
	t-=mm*60;
	var ss=t|0;
	var ff=((t-ss)*30)|0;
	return ("00"+hh).substr(-2)+":"+("00"+mm).substr(-2)+":"+("00"+ss).substr(-2);
//	return ("00"+hh).substr(-2)+":"+("00"+mm).substr(-2)+":"+("00"+ss).substr(-2)+":"+("00"+ff).substr(-2);
}
function Automation_None(actx,param,v,t){
	this.param=param;
	this.cancelScheduledValues=function(t){
		this.param.cancelScheduledValues(t);
	};
	this.setValueAtTime=function(v,t){
		this.param.setValueAtTime(v,t);
	};
	this.linearRampToValueAtTime=function(v,t){
		this.param.linearRampToValueAtTime(v,t);
	};
	this.setTargetAtTime=function(v,t,c){
		this.param.setTargetAtTime(v,t,c);
	};
}
function Automation(actx,param,v,t){
	this.actx=actx;
	this.param=param;
	this.cmdbuf=[];
	this.cnt=0;
	this.Cancel=function(){
		while(this.cmdbuf.length && this.actx.currentTime>this.cmdbuf[0][2])
			this.cmdbuf.shift();
	};
	this.Reque=function(){
		if(this.cnt++<1000)
			return;
		this.cnt=0;
		this.param.cancelScheduledValues(0);
		for(var i=0,l=this.cmdbuf.length;i<l;++i){
			var buf=this.cmdbuf[i];
			switch(buf[0]){
			case 0:
				this.param.setValueAtTime(buf[1],buf[2]);
				break;
			case 1:
				this.param.linearRampToValueAtTime(buf[1],buf[2]);
				break;
			case 2:
				this.param.exponentialRampToValueAtTime(buf[1],buf[2]);
				break;
			case 3:
				this.param.setTargetAtTime(buf[1],buf[2],buf[3]);
				break;
			}
		}
	};
	this.cancelScheduledValues=function(t){
		this.param.cancelScheduledValues(t);
	};
	this.setValueAtTime=function(v,t){
		this.Cancel();
		this.cmdbuf.push([0,v,t]);
		this.param.setValueAtTime(v,t);
		this.Reque();
	};
	this.linearRampToValueAtTime=function(v,t){
		this.Cancel();
		this.cmdbuf.push([1,v,t]);
		this.param.linearRampToValueAtTime(v,t);
		this.Reque();
	};
	this.exponentialRampToValueAtTime=function(v,t){
		this.Cancel();
		this.cmdbuf.push([2,v,t]);
		this.exponentialRampToValueAtTime(v,t);
		this.Reque();
	};
	this.setTargetAtTime=function(v,t,c){
		this.Cancel();
		this.cmdbuf.push([3,v,t,c]);
		this.param.setTargetAtTime(v,t,c);
		this.Reque();
	};
}
function Interval() {
	var current=audioctx.currentTime;
	var err;
	animInterval(current*1000);
	while(current>=nextTime-.2) {
		++tick;
		master.next(nextTime);
		bdo.next(nextTime);
		sdo.next(nextTime);
		hho.next(nextTime);
		cyo.next(nextTime);
		o1.next(nextTime);
		o2.next(nextTime);
		o3.next(nextTime);
		o4.next(nextTime);
		o5.next(nextTime);
		o6.next(nextTime);
		o7.next(nextTime);
		o8.next(nextTime);
		delay.next(nextTime);
		var c4=tick&3;
		var c8=tick&7;
		var c16=tick&15;
		var c32=tick&31;
		var c64=tick&63;
		var c96=tick%96;
		var c128=tick&127;
		++cnt;
		lfo1=cnt&1;
		lfo2=((c4>2)?4-c4:c4)*.5;
		lfo4=((c8>4)?8-c8:c8)*.25;
		lfo8=((c16>8)?16-c16:c16)*.125;
		lfo16=((c32>16)?32-c32:c32)*.0625;
		lfo32=((c64>32)?64-c64:c64)*.03125;
		lfo48=((c96>48)?96-c96:c96)/48;
		lfo64=((c128>64)?128-c128:c128)*.015625;
		if((tick&1)==0) sh1=Math.random();
		if(c4==0) sh2=Math.random();
		if(c8==0) sh4=Math.random();
		if(c16==0) sh8=Math.random();
		if(c32==0) sh16=Math.random();
		if(c64==0) sh32=Math.random();
		if(c96==0) sh48=Math.random();
		if(c128==0) sh64=Math.random();
//		var a=0;
//		for(var i=0;i<512;++i) {
//			var t=wavdat[i]-128;
//			a+=t*t;
//		}
//		lev=Math.sqrt(a/512)/256;
		if(nextTime==0)
			nextTime=current;
		nextTime+=15/master._tempo;
	}
}
function lfo(t) {
	var l=t|0;
	var l2=l/2;
	var p=tick%l;
	p=(p>=l2)?l-p:p;
	return p/l2;
}
function hsv(h,s,v) {
	h=h-(h|0);
	if(s>1) s=s-(s|0);
	if(v>1) v=v-(v|0);
	var r=v,g=v,b=v;
	if(s>0) {
		h*=6.0;
		var hh=h|0;
		var f=h-hh;
		var r,g,b;
		switch(hh) {
		case 0:
			g=v-v*s*(1-f);
			b=v-v*s;
			break;
		case 1:
			r=v-v*s*f;
			b=v-v*s;
			break;
		case 2:
			r=v-v*s;
			b=v-v*s*(1-f);
			break;
		case 3:
			r=v-v*s;
			g=v-v*s*f;
			break;
		case 4:
			r=v-v*s*(1-f);
			g=v-v*s;
			break;
		case 5:
			g=v-v*s;
			b=v-v*s*f;
			break;
		}
	}
	return "rgb("+(r*255|0)+","+(g*255|0)+","+(b*255|0)+")";
}
function hue(h) {
	h-=(h|0);
	var t=h*6;
	var r=g=b=0;
	if(t<1) {
		r=255;
		g=(t*255)|0;
		b=0;
	}
	else if(t<2) {
		r=((2-t)*255)|0;
		g=255;
		b=0;
	}
	else if(t<3) {
		r=0;
		g=255;
		b=((t-2)*255)|0;
	}
	else if(t<4) {
		r=0;
		g=((4-t)*255)|0;
		b=255;
	}
	else if(t<5) {
		r=((t-4)*255)|0;
		g=0;
		b=255;
	}
	else {
		r=255;
		g=0;
		b=((6-t)*255)|0;
	}
	return "rgb("+r+","+g+","+b+")";
}
function replaceplugin(s) {
	if(typeof(s)=="string") {
		for(var i=0;i<plugins.length;++i) {
			s=s.replace(new RegExp(plugins[i].name+"\.([a-z]*)","g"),"plugins["+i+"].obj.param.$1.value");
		}
	}
	return s;
}
function streval(s) {
	if(s=="s") return s;
	if(s=="l") return s;
	var l=s;
	for(;;) {
		if(typeof(s)=="string") {
			l=s;
			try {
				s=eval(s);
			} catch(e) {return l;}
		}
		else
			return l;
	}
}
function numeval(s) {
	try {
		for(;;) {
			var t=typeof(s);
			switch(t) {
			case "number":
				return s;
			case "string":
				s=eval(replaceplugin(s));
				break;
			default:
				return 0;
			}
		}
	} catch(e) {return 0;}
}
function Note2Vol(n) {
	n-=48;
	if(n<0)
		return 0;
	return 2/(n+2);
}
function Noise() {
	this.scr=audioctx.createScriptProcessor(1024,1,1);
	this.Process=function(ev) {
//		Interval();
//		var buf=ev.getChannelData(0);
//		for(var i=0;i<1024;++i)
//			buf.data[i]=Math.random()*.5;
	};
	this.scr.onaudioprocess=this.Process;
	this.scr.connect(out);
}
function OSC(f,v,t,to) {
	this.ena=0;
	this.form={0:"sine",1:"sawtooth",2:"square"};
	this.Osc=audioctx.createOscillator();
	this.OscDetune=new Automation(audioctx,this.Osc.detune);
	this.OscFrequency=new Automation(audioctx,this.Osc.frequency);
	this.Fil=audioctx.createBiquadFilter();
	this.FilFrequency=new Automation(audioctx,this.Fil.frequency);
	this.FilDetune=new Automation(audioctx,this.Fil.detune);
	this.Gain=audioctx.createGain();
	this.GainGain=new Automation(audioctx,this.Gain.gain);
	this.Mod=audioctx.createGain();
	this.Send=audioctx.createGain();
	this.Pan=audioctx.createStereoPanner();
	this.Osc.connect(this.Fil);
	this.Fil.connect(this.Gain);
	this.Gain.connect(this.Mod);
	this.Gain.connect(this.Send);
	this.Send.connect(delay.Dly);
	this.Gain.connect(this.Pan);
	this.Gain.connect(this.Mod);
	this.Gain.gain.value=0;
	this.Send.gain.value=0;
	this.Mod.gain.value=1000;
	if(to) {
		this.Pan.connect(to);
	}
	this.s="r";
	this.g="c";
	this.type=t;
	this.c=20;
	this.q=10;
	this.v=v;
	this.pan=0.5;
	this.step=0;
	this._out=null;
	this.out="master";
	this.freq="";
	this.delay=0.0;
	this.f=f;
	this.d=1;
	this.Osc.start(0);
	this.tune=0;
	this.next=function(t) {
		this.Send.gain.value=this.delay;
		this.Osc.type=this.form[numeval(this.type)];
		var s=Mml(streval(this.s));
		this.step=tick%s.length;
		var tune=s[this.step];
		var g=Mml(streval(this.g));
		var v=Note2Vol(g[tick%g.length]);
		if(this._out!=this.out) {
			this._out=this.out;
			this.Pan.disconnect();
			this.Mod.disconnect();
			if(this._out=="master")
				this.Pan.connect(master.out);
			else {
				this.Gain.connect(this.Mod);
				try {
					this.Mod.connect(eval(this.out).Osc.frequency);
				} catch(e) {}
			}
		}
		if(tune) {
			tune=(tune-57)*100;
			this.OscDetune.setValueAtTime(tune,t);
			this.FilDetune.setValueAtTime(tune,t);
			var _freq=numeval(this.f);
			this.OscFrequency.setValueAtTime(_freq,t);
			var _cutoff=numeval(this.c);
			this.FilFrequency.setValueAtTime(_freq*_cutoff,t);
			this.Fil.Q.value=numeval(this.q);
			this.GainGain.setTargetAtTime(numeval(this.v)*v,t,0.001);
			this.GainGain.setTargetAtTime(0,t+0.01,Math.max(.02,numeval(this.d)));
			this.tune=tune;
		}
		else {
			this.GainGain.setTargetAtTime(0,t,0.01);
		}
		this.Pan.pan.value=(numeval(this.pan)-0.5)*2;
	}
}
function FMO(f1,p1,v1,r1,t1,f2,p2,v2,r2,t2,f3,p3,v3,r3,t3,pan) {
	this.Op1=audioctx.createOscillator();
	this.Op1gain=audioctx.createGain();
	this.Op2=audioctx.createOscillator();
	this.Op2gain=audioctx.createGain();
	this.Op3=audioctx.createOscillator();
	this.Op3gain=audioctx.createGain();
	this.Pan=audioctx.createStereoPanner();
	this.form={0:"sine",1:"sawtooth",2:"square"};

	this.Op3.connect(this.Op3gain);
	this.Op3gain.connect(this.Op2.frequency);
	this.Op2.connect(this.Op2gain);
	this.Op2gain.connect(this.Op1.frequency);
	this.Op1.connect(this.Op1gain);
	this.Op1gain.connect(this.Pan);
	this.Pan.connect(master.out);
	this.Op1gain.gain.value=0;
	this.s="r";
	this.step=0;
	this.f1=f1;
	this.p1=p1;
	this._v=this.v=v1;
	this.r1=r1;
	this.f2=f2;
	this.p2=p2;
	this.v2=v2;
	this.r2=r2;
	this.f3=f3;
	this.p3=p3;
	this.v3=v3;
	this.r3=r3;
	this.pan=pan;
	this.Op1.start(0);
	this.Op2.start(0);
	this.Op3.start(0);
	this.Op1.frequency.value=f1;
	this.Op2.frequency.value=f2;
	this.Op3.frequency.value=f3;
	this.Op1.type=this.form[t1];
	this.Op2.type=this.form[t2];
	this.Op3.type=this.form[t3];
	this.Op1gaingain=new Automation(audioctx,this.Op1gain.gain);
	this.Op2gaingain=new Automation(audioctx,this.Op2gain.gain);
	this.Op3gaingain=new Automation(audioctx,this.Op3gain.gain);
	this.Op1frequency=new Automation(audioctx,this.Op1.frequency);
	this.Op2frequency=new Automation(audioctx,this.Op2.frequency);
	this.Op3frequency=new Automation(audioctx,this.Op3.frequency);
/*	this.trig=function(t) {
		this.Op1gain.gain.cancelScheduledValues(t);
//		this.Op1gain.gain.setValueAtTime(0,t);
//		this.Op1gain.linearRampToValueAtTime(this.v[i],t+0.005);
		this.Op1gain.setValueAtTime(this.v[i],t);
		this.Op1gain.gain.linearRampToValueAtTime(0,t+0.006+this.h*0.075);
	}*/
	this.trig=function(t) {
//		this.Op1gaingain.cancelScheduledValues(t);
//		this.Op2gaingain.cancelScheduledValues(t);
//		this.Op3gaingain.cancelScheduledValues(t);
//		this.Op1frequency.cancelScheduledValues(t);
//		this.Op2frequency.cancelScheduledValues(t);
		this.Op1gaingain.setValueAtTime(0,t);
		this.Op1gaingain.linearRampToValueAtTime(this._v,t+0.001);
		this.Op2gaingain.setValueAtTime(this.v2,t);
		this.Op3gaingain.setValueAtTime(this.v3,t);
		this.Op1frequency.setValueAtTime(this.f1,t);
		this.Op2frequency.setValueAtTime(this.f2,t);
		this.Op1gaingain.setTargetAtTime(0,t+0.01,this.r1);
		this.Op2gaingain.setTargetAtTime(0,t+0.01,this.r2);
		this.Op3gaingain.setTargetAtTime(0,t+0.01,this.r3);
		this.Op1frequency.setTargetAtTime(this.f1*this.p1,t+0.011,this.r1);
		this.Op2frequency.setTargetAtTime(this.f2*this.p2,t+0.011,this.r2);
		this.Op3frequency.setTargetAtTime(this.f3*this.p3,t+0.011,this.r3);
//		this.Op1gaingain.linearRampToValueAtTime(0,t+0.06+this.r1);
//		this.Op2gaingain.linearRampToValueAtTime(0,t+0.06+this.r2);
//		this.Op3gaingain.linearRampToValueAtTime(0,t+0.06+this.r3);
	}
	this.next=function(t) {
		var s=Mml(streval(this.s));
		this.step=tick%s.length;
		var c=s[this.step];
		this._v=numeval(this.v);
		if(c) {
			var n=(c-48)*100;
			this.Op1.detune.value=n;
			this.trig(t);
		}
		this.Pan.pan.value=(this.pan-0.5)*2;
	}
}
function BOSC(n,v){
	this.s="r";
	this.step=0;
	this.bufnum=n;
	this.gain=audioctx.createGain();
	this.gaingain=new Automation(audioctx,this.gain.gain);
	this.gain.connect(master.out);
	this.gain.gain.value=this._v=this.v=v;
	this.trig=function(t) {
		var bufsrc=audioctx.createBufferSource();
		if(shot[this.bufnum]){
			bufsrc.buffer=shot[this.bufnum].data;
			bufsrc.connect(this.gain);
			bufsrc.start(t);
			this.gaingain.setValueAtTime(this._v,t);
		}
	}
	this.next=function(t) {
		var s=Mml(streval(this.s));
		this.step=tick%s.length;
		var c=s[this.step];
		this._v=numeval(this.v);
		if(c) {
			this.trig(t);
		}
//		this.Pan.pan.value=(this.pan-0.5)*2;
	}
}
function Master() {
	function GetName(s) {
		var p=s.lastIndexOf("/");
		return s.substr(p+1);
	}
	function LoadSample(buf,n,url) {
		var req = new XMLHttpRequest();
		req.open("GET", url, true);
		req.responseType = "arraybuffer";
		req.nam=GetName(url);
		req.onload = function() {
			if(req.response) {
				audioctx.decodeAudioData(req.response,function(b){buf[n]={"name":req.nam,"data":b};},function(){});
			}
		}
		req.onerror=function() {
			window.xhrreqerr=true;
		}
		try {req.send();} catch(e){}
	}
	LoadSample(ir,0,"samples/IMreverbs1/Five Columns Long.wav");
	LoadSample(ir,1,"samples/IMreverbs1/Five Columns.wav");
	LoadSample(ir,2,"samples/IMreverbs1/French 18th Century Salon.wav");
	LoadSample(ir,3,"samples/IMreverbs1/Going Home.wav");
	LoadSample(ir,4,"samples/IMreverbs1/In The Silo Revised.wav");
	LoadSample(ir,5,"samples/IMreverbs1/Narrow Bumpy Space.wav");
	LoadSample(ir,6,"samples/IMreverbs1/Nice Drum Room.wav");
	LoadSample(ir,7,"samples/IMreverbs1/Parking Garage.wav");
	LoadSample(ir,8,"samples/IMreverbs1/Rays.wav");
	LoadSample(ir,9,"samples/IMreverbs1/Trig Room.wav");
	LoadSample(shot,0,"samples/kick.wav");
	LoadSample(shot,1,"samples/snare.wav");
	LoadSample(shot,2,"samples/chh.wav");

	this.v=this._v=1.0;
	this.fade=.1;
	this.conv=audioctx.createConvolver();
	this.convgain=audioctx.createGain();
	this.comp=audioctx.createDynamicsCompressor();
	this.out=audioctx.createDelay();
	this.gain=audioctx.createGain();
	this.gain.gain=1;
	this.delaylfo=audioctx.createOscillator();
	this.delaylfo.frequency.value=55;
	this.delaylfofrequency=new Automation(audioctx,this.delaylfo.frequency);
	this.delaylfo.start(0);
	this.delaylfogain=audioctx.createGain();
	this.delaylfogain.gain.value=0;
	this.delaylfo.connect(this.delaylfogain);
	this.delaylfogain.connect(this.out.delayTime);
	this.delaylfogaingain=new Automation(audioctx,this.delaylfogain.gain);
	this.outdelay=new Automation(audioctx,this.out.delayTime);
	this.gaingain=new Automation(audioctx,this.gain.gain);
	this.ana=audioctx.createAnalyser();
	this.ana.fftSize=1024;
	this.out.connect(this.gain);
	this.gain.connect(this.conv);
	this.gain.connect(this.comp);
	this.conv.connect(this.convgain);
	this.convgain.connect(this.comp);
	this.comp.connect(audioctx.destination);
	this.comp.connect(this.ana);
	this.tccnt=0;
	this.g="0";
	this.ir=0;
	this._rev=this.rev=.5;
	this._tempo=this.tempo=120;
	this.step=0;
	this.run=1;
	this.step0=0;
	this.next=function(t) {
		this._tempo=numeval(this.tempo);
		var step0=((tick/4)|0);
		var fsuparam=this.g[step0%this.g.length];
		var _v=numeval(this.v);
		this._rev=numeval(this.rev);
		this.convgain.gain.value=this._rev;
		this._v+=(_v-this._v)*this.fade;
		var p0=15/this._tempo;
		if(step0!=this.step0){
			this.step0=step0;
			switch(fsuparam){
			case "p":
				PeerStart();
				break;
			}
		}
		switch(fsuparam){
		case "1":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			this.gaingain.setTargetAtTime(0,t+p0*.5,0.01);
			break;
		case "2":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime(0,t);
			this.gaingain.setValueAtTime(this._v,t);
			this.gaingain.setTargetAtTime(0,t+p0*.5,0.01);
			break;
		case "3":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.outdelay.setValueAtTime((tick&3)*p0+p0*.5,t+p0*.5);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "4":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime((3-(tick&3))*p0,t);
			this.outdelay.setValueAtTime((3-(tick&3))*p0+p0*.5,t+p0*.5);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "5":
			this.delaylfofrequency.setValueAtTime(55,t);
			this.delaylfogaingain.setValueAtTime(.01,t);
			this.outdelay.setValueAtTime(p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "6":
			this.delaylfofrequency.setValueAtTime(880,t);
			this.delaylfogaingain.setValueAtTime(.01,t);
			this.outdelay.setValueAtTime(p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "7":
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.delaylfofrequency.setValueAtTime(10,t);
			this.delaylfogaingain.setValueAtTime(.01,t);
			this.gaingain.setValueAtTime(this._v,t);
			break;
		case "8":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.delaylfofrequency.setValueAtTime(10,t);
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			this.gaingain.setTargetAtTime(0,t+p0*.5,0.01);
			this.delaylfogaingain.setValueAtTime(.1*(tick&2),t);
			break;
		case "9":
			this.delaylfogaingain.setValueAtTime(0,t);
			this.delaylfofrequency.setValueAtTime(1,t);
			this.outdelay.setValueAtTime((tick&3)*p0,t);
			this.gaingain.setValueAtTime(this._v,t);
			this.gaingain.setTargetAtTime(0,t+p0*.5,0.01);
			this.delaylfogaingain.setValueAtTime(.1*(tick&2),t);
			break;
		case "0":
		default:
			this.delaylfogaingain.setValueAtTime(0,t);
			this.outdelay.setValueAtTime(0,t);
			this.gaingain.setValueAtTime(this._v,t);
		}
	}
}
function Delay() {
	this.Dly=audioctx.createDelay();
	this.Dly.delayTime.value=60/master._tempo;
	this.Fb=audioctx.createGain();
	this.Fb.gain.value=.5;
	this.Dly.connect(this.Fb);
	this.Dly.connect(out);
	this.Fb.connect(this.Dly)
	this.t=8;
	this.fb=.5;
	this.next=function() {
		var n=4/numeval(this.t);
		this.Fb.gain.value=numeval(this.fb);
		this.Dly.delayTime.value=60*n/master._tempo+0.02;
	}
}
function MidiIn(e){
	for(var i=midicb.length-1;i>=0;--i)
		midicb[i].func.bind(midicb[i].plug)(e);
}
function Midi() {
	console.log("---MIDI---");
	this.onMIDIFailure=function(msg) {console.log(msg);};
	this.onMIDISuccess=function(ac) {
		console.log("requestMIDIAccess:success");
		var i=ac.outputs.values();
		midioutputs=[];
		for (var o=i.next(); !o.done; o=i.next()) {
			midioutputs.push(o.value);
		}
		console.log("number of midiout ports:"+midioutputs.length);
		i=ac.inputs.values();
		midiinputs=[];
		for(o=i.next();!o.done;o=i.next()){
			midiinputs.push(o.value);
			o.value.onmidimessage=MidiIn;
		}
	};
	if(navigator.requestMIDIAccess) {
		navigator.requestMIDIAccess().then(this.onMIDISuccess,this.onMIDIFailure);
		this.setup=function(midiout) {
			if(midiout) {
				midiout.send([0xb0,70,125]);	//detune
				midiout.send([0xb0,76,55]);	//lfo rate
			}
		}
	}
}
function Cmds() {
	this.cursor=0;
	this.log=[];
	this.log.push("> ");
	this.hist=[];
	this.histcur=0;
	this.rows=25;
	this.dirty=1;
	this.message=function(mess) {
		this.log.splice(1,0,mess);
		if(this.log.length>this.rows)
			this.log.length=this.rows;
		this.dirty=1;
	}
	this.key=function(k) {
		if(k[0]=="f") {
			this.log[0]="> "+fn[k[1]-1];
			this.cursor=this.log[0].length;
			this.dirty=1;
			return;
		}
		switch(k) {
		case "l":
			return;
		case "u":
			if(this.histcur<this.hist.length-1) {
				++this.histcur;
				this.log[0]=this.hist[this.histcur];
				this.cursor=this.log[0].length;
				this.dirty=1;
			}
			return;
		case "r":
			return;
		case "d":
			if(this.histcur>=0) {
				--this.histcur;
				if(this.histcur==-1) {
					this.log[0]="> ";
					this.cursor=2;
				}
				else {
					this.log[0]=this.hist[this.histcur];
					this.cursor=this.log[0].length;
				}
				this.dirty=1;
			}
			return;
		case 8:
			if(this.cursor>2) {
				this.log[0]=this.log[0].slice(0,-1);
				--this.cursor;
				this.dirty=1;
			}
			return;
		case 13:
			this.histcur=-1;
			this.hist.unshift(this.log[0]);
			if(this.hist.length>10)
				this.hist.length=10;
			var s=Enter(this.log[0].substr(2));
			this.cursor=0;
			if(s!=undefined) {
				var ss=s.split("\n");
				for(ii=0;ii<ss.length-1;++ii) {
					this.log.unshift(ss[ii]);
					this.log.length=this.rows;
				}
			}
			this.log.unshift("> ");
			this.dirty=1;
			return;
		}
		var s=String.fromCharCode(k);
		this.log[0]+=s;
		this.cursor=this.log[0].length;
		this.histcur=-1;
		this.dirty=1;
	}
}
function Video() {
	this.video=document.getElementById("video");
	function err(err) {
		cmds.message("video is not available.");
	}
	function success(stream) {
		var v=document.getElementById("video");
		v.src= window.URL.createObjectURL(stream);
		v.width=320;
		v.height=240;
		v.play();
		this.stream=stream;
	}
	this.cam=[];
	navigator.mediaDevices.enumerateDevices().then(
		function(devices){
			for(var i=0,j=0,len=devices.length;i<len;++i){
				var device=devices[i];
				if(device.kind=="videoinput"){
					cmds.message("video "+j+":"+device.deviceId);
					this.cam.push(device.deviceId);
					++j;
				}
			}
		}.bind(this)
	);
/*
	if(MediaStreamTrack.getSources){
		MediaStreamTrack.getSources(function(data){
			var len=data.length;
			for(var i=0,j=0;i<len;++i){
				if(data[i].kind=="video"){
					cmds.message("video "+j+":"+data[i].id);
					this.cam.push(data[i].id);
					++j;
				}
			}
		}.bind(this));
	}
	*/
	this.Switch=function(n){
		if(n<0||n>=this.cam.length)
			return;
		navigator.getUserMedia({video:{optional:[{sourceId:this.cam[n]}]},audio:false},success.bind(this),err);
	};
	navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;
	if(typeof(navigator.getUserMedia)=="function") {
		navigator.getUserMedia( {video: true},success.bind(this),err);
	}
}
</script>
<div id="base" style="position:absolute;left:0px;top:0px;background:#000;overflow:hidden">
</div>
<div id="topmost" style="position:absolute;left:0px;top:0px;overflow:hidden">
</div>
<div id="timecode" style="position:absolute;border:none;margin:0px;padding:0px;right:2px;bottom:5px;width:120px;height:20px;color:#aaa;font-size:20px;font-family:courier"></div>
<div style="display:none">
	<video id="video" width="320" height="240"></video>
<!--	<canvas id="cvcamwork" width="80" height="60"></canvas>-->
</div>
</body>
</html>
