<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<script src="web-audio-engine.js"></script>
<script>
var actx=new AudioContext();
var osc=actx.createOscillator();
var gain=actx.createGain();
var gaingain=new Automation(actx,gain.gain);
gain.gain.value=0;
osc.connect(gain);
gain.connect(actx.destination);
osc.start(0);

function Automation(ctx,param,v,t){
    this.param = param;
    this.cmdbuf = [];
    this.Cancel = function(){
        while(this.cmdbuf.length && ctx.currentTime > this.cmdbuf[0][2])
            this.cmdbuf.shift();
    };
    this.Reque = function(){
        this.param.cancelScheduledValues(0);
        for(var i = 0,l = this.cmdbuf.length; i < l; ++i){
            var buf = this.cmdbuf[i];
            switch(buf[0]){
            case 0:
                this.param.setValueAtTime(buf[1],buf[2]);
                break;
            case 1:
                this.param.linearRampToValueAtTime(buf[1],buf[2]);
                break;
            case 2:
                this.param.exponentialRampToValueAtTime(buf[1],buf[2]);
                break;
            case 3:
                this.param.setTargetAtTime(buf[1],buf[2],buf[3]);
                break;
            }
        }
    };
    this.cancelScheduledValues = function(t){
        this.cancelScheduledValues(t);
    };
    this.setValueAtTime = function(v,t){
        this.Cancel();
        this.cmdbuf.push([0,v,t]);
        this.Reque();
    };
    this.linearRampToValueAtTime = function(v,t){
        this.Cancel();
        this.cmdbuf.push([1,v,t]);
        this.Reque();
    };
    this.exponentialRampToValueAtTime = function(v,t){
        this.Cancel();
        this.cmdbuf.push([2,v,t]);
        this.Reque();
    };
    this.setTargetAtTime = function(v,t,c){
        this.Cancel();
        this.cmdbuf.push([3,v,t,c]);
        this.Reque();
    };
}

function Trigger(){
  var t=actx.currentTime;
  gaingain.setValueAtTime(0,t+0.1);
  gaingain.setValueAtTime(1,t+0.101);
  gaingain.setValueAtTime(0,t+0.102);
  gaingain.setValueAtTime(1,t+0.103);
  gaingain.setValueAtTime(0,t+0.104);
}

function Run(){
  setInterval(Trigger,50);
}
</script>
</head>
<body>
  <button onclick="Run()">Run</button>
</body>
</html>
