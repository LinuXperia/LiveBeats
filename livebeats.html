<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Live Beats | g200kg Music &amp; Software</title>
</head>
<body onload="Init()" style="background:#000">
<script type="text/javascript" src="./vj_wave.js"></script>
<script type="text/javascript" src="./vj_matrix.js"></script>
<script type="text/javascript">
var buffers = [];
var loadidx=0;
var req = new XMLHttpRequest();
var cvtxt,ctxtxt,cvtxtwork,ctxtxtwork;
var wavdat=new Uint8Array(512);
var freqdat=new Uint8Array(256);
var cnt=0;
var lfo1=0;
var lfo2=0;
var lfo4=0;
var lfo8=0;
var lfo16=0;
var lfo32=0;
var lfo48=0;
var lfo64=0;
var sh1=0;
var sh2=0;
var sh4=0;
var sh8=0;
var sh16=0;
var rand1=rand2=rand4=0;
var lev=0;
var bd1="crrrcrrrcrrrcrcr";
var sd1="rrrrcrrrrrrrcrrr";
var hh1="crcrcrcrcrcrcrcc";
var s0="rrrrrrrrrrrrrrrr";
var s1="crrrcrrrcrrrcrrr";
var s2="aarrddrrcrcrerrr";
var s3="gagarrrrddrreerr";
var s4="grrrddeegrrrddcc";
var s5="errrcrerarddcrrr";
var s6="crrrargrdcgrardr";
var s7="ererggeecdrcgrrr";
var s8="errrarrrgrrrerfr";
var s9="ddddrrrrggggdddd";
var s10="crrrcrrrcrrrcrrr";
var s11="aaaarrrrrrrrrrrr";
var s12="aaaarrrrddddrrrr";
var s13="ddggrraaaaggdrdr";
var s14="arrrggrrgrrreerr";
var s15="crargrcrarrrdrrr";
var s16="rrrrgrggrrrreree";
var s17="crrrdrerrrcrdrer";
var s18="eeeerrddeeeerrgg";
var s19="arrrrrrrrrrrrrrr";
var s20="cdegacdegeadcged";
var s21="dadcgagcacdegaed";
var s23="grcdgrcdarrrabab";
var s24="eergeergaardaard";
var tick=0;
var nextTime=0;

var master=null;
var o1,o2,o3,o4,o5,o6,o7,o8;
var delay;
var cam=null;
var eff=null;
var elEff=null;
var scrWidth=100;
var scrHeight=100;

var list=[];
var ir=[];
var plugins=[];
var pluginsparam=[];
var pluginsparamval=[];

var fn=[
	"wav.type=0;wav.effy=4;wav.effx=1",
	"wav.type=2;wav.z=1;wav.fill=1;wav.effz=1.1;wav.effr=.7",
	"wav.type=3;wav.x=.5;wav.z=1.5;wav.effx=0;wav.effy=0;wav.effz=1;wav.effr=.9",
	"",
	"cam.a=0;cam.v=0;wav.a=0",
	"",
	"bdo.v=0;sdo.v=0;hho.v=0;cam.v=0",
	"bdo.v=.5;sdo.v=.5;hho.v=.5",
	"",
	"",
	"",
	"",
];

function Trigger(instrument,accent,when) {
	if(accent==0)
		return;
	var src=audio.createBufferSource();
	src.buffer=buffers[instrument];
	var g=audio.createGain();
	g.gain.value=0.8;
	src.connect(g);
	g.connect(out);
	src.start(when);
}
function DragOver(ev) {
	ev.stopPropagation();
	ev.preventDefault();
	ev.dataTransfer.dropEffect="copy";
}
function LoadPlugin(s,script,name) {
	eval(s);
	var plug={"script":script,"name":name};
	eval("plug.obj=new "+script+"({'w':1024,'h':768,'n':512,'wavedat':wavdat,'freqdat':freqdat})");
	InitPlugin(plug);
}
function InitPlugin(plug) {
	plug.obj.elem.style.position="absolute";
	plug.obj.elem.style.left="0px";
	plug.obj.elem.style.top="0px";
	plugins.push(plug);
	pluginsparam.push({});
	var p={
		"a":{"value":1,"min":0,"max":1},
		"blur":{"value":0,"min":0,"max":10},
		"rot":{"value":0,"min":-360,"max":360},
		"w":{"value":1,"min":0,"max":1},
		"h":{"value":1,"min":0,"max":1},
		"x":{"value":.5,"min":0,"max":1},
		"y":{"value":.5,"min":0,"max":1},
		"z":{"value":1,"min":0,"max":2},
	};
	for(var j in plug.obj.param)
		p[j]=plug.obj.param[j];
	plug.obj.param=p;
	document.getElementById("base").appendChild(plug.obj.elem);
	txt.message("plugin '"+plug.script+"' is loaded as:"+plug.name);
}
function FileDrop(ev) {
	ev.stopPropagation();
	ev.preventDefault();
	var files=ev.dataTransfer.files;
	var name=files[0].name;
	if(name.indexOf("vj_")==0 && name.lastIndexOf(".js")==name.length-3) {
		name=name.substr(0,name.length-3);
		var reader=new FileReader();
		reader.onload=function(ev) {
			LoadPlugin(ev.target.result,this.name,"plug"+plugins.length);
		};
		reader.name=name;
		reader.readAsText(files[0]);
	}
}
function animInterval(timestamp) {
	master.ana.getByteTimeDomainData(wavdat);
	master.ana.getByteFrequencyData(freqdat);
	for(var i=0,e=plugins.length;i<e;++i) {
		var plug=plugins[i].obj;
		var plugparam=pluginsparam[i];
		plug.anim(timestamp);
		for(var j in plugparam) {
			if(isNaN(plug.param[j].value))
				plug.param[j].value=0;
			switch(plug.param[j].type) {
			case "string":
			case "int":
				plug.param[j].value=streval(plugparam[j]);
				break;
			case "double":
			default:
				plug.param[j].value+=(numeval(plugparam[j])-plug.param[j].value)*.2;
				break;
			}
		}
		var w=plug.param.w.value*plug.param.z.value;
		var h=plug.param.h.value*plug.param.z.value;
		plug.elem.style.left=((scrWidth*plug.param.x.value-scrWidth*w*.5)|0)+"px";
		plug.elem.style.top=((scrHeight*plug.param.y.value-scrHeight*h*.5)|0)+"px";
		plug.elem.style.width=((scrWidth*w)|0)+"px";
		plug.elem.style.height=((scrHeight*h)|0)+"px";
		plug.elem.style.opacity=plug.param.a.value;
		plug.elem.style.WebkitFilter="blur("+(plug.param.blur.value|0)+"px)";
		plug.elem.style.WebkitTransform="rotate("+plug.param.rot.value+"deg)";
	}
	window.requestAnimationFrame(animInterval);
}
function Init() {
	window.AudioContext=window.webkitAudioContext||window.AudioContext;
	audio=new AudioContext();
	midi=new Midi();
	master=new Master();
	out=master.out;
	run=1;
	delay=new Delay();
	noise=new Noise();
	o1=new OSC(110,0.4,1,out);
	o2=new OSC(440,0.3,1,out);
	o3=new OSC(440,0.3,1,out);
	o4=new OSC(880,0.3,1,out);
	o5=new OSC(110,0.3,1,out);
	o6=new OSC(440,0.3,1,out);
	o7=new OSC(440,0.3,1,out);
	o8=new OSC(880,0.3,1,out);
	bdo=new FMO(25,1,.05,2, 29,400,.01,0, 131,100,.001,0,.5);
	sdo=new FMO(213,.4,.1,0, 723,1900,.6,0, 140,800,.1,0,.3);
	hho=new FMO(2200,.4,.02,0, 423,3120,.5,0, 552,1800,.1,1,.7);
	cyo=new FMO(2612,.2,.4,0, 1826,4219,5,2, 3897,1401,1,2,.4);
	cvtxt=document.getElementById("cvtxt");
	ctxtxt=cvtxt.getContext("2d");
	cvtxtwork=document.getElementById("cvtxtwork");
	ctxtxtwork=cvtxtwork.getContext("2d");
	txt=new Txt();
	cam=new Cam();
	Resize();
	window.addEventListener("resize",Resize);
	window.document.addEventListener("keypress",KeyPress);
	window.document.addEventListener("keydown",KeyDown);
	Reset();
	txt.message("LiveBeats initialized.");
	txt.message("");
	if(window.xhrreqerr) {
		txt.message("IR files cannot be loaded, 'master.ir' is desabled.");
		txt.message("  May be connect with 'file:///'?");
		txt.message("  Should be placed on WebServer and connect with http://");
	}
	window.requestAnimationFrame(animInterval);
	document.addEventListener("dragover",DragOver,false);
	document.addEventListener("drop",FileDrop,false);
	var plug;
	plug={"script":"vj_matrix","name":"mat","obj":new vj_matrix({"w":1024,"h":768,"wavedat":wavdat,"freqdat":freqdat})};
	InitPlugin(plug);
	plug={"script":"vj_wave","name":"wav","obj":new vj_wave({"w":1024,"h":768,"wavedat":wavdat,"freqdat":freqdat})};
	InitPlugin(plug);
}
function Resize() {
	scrWidth=document.body.clientWidth;
	scrHeight=window.innerHeight-20;
	var b=document.getElementById("base");
	b.style.width=scrWidth+"px";
	b.style.height=scrHeight+"px";
	b=document.getElementById("base2");
	b.style.width=scrWidth+"px";
	b.style.height=scrHeight+"px";
	cam.layout();
}
function KeyDown(ev) {
	switch(ev.keyCode) {
	case 8:
		txt.key(8);
		ev.preventDefault();
		return false;
	case 13:
		txt.key(13);
		ev.preventDefault();
		return false;
	case 37:  //left
		txt.key("l");
		ev.preventDefault();
		return false;
	case 38:  //up
		txt.key("u");
		ev.preventDefault();
		return false;
	case 39:  //right
		txt.key("r");
		ev.preventDefault();
		return false;
	case 40:  //down
		txt.key("d");
		ev.preventDefault();
		return false;
	case 112:  //f1 
		txt.key("f1");
		ev.preventDefault();
		return false;
	case 113:  //f2
		txt.key("f2");
		ev.preventDefault();
		return false;
	case 114:  //f3
		txt.key("f3");
		ev.preventDefault();
		return false;
	case 115:  //f4
		txt.key("f4");
		ev.preventDefault();
		return false;
	case 116:  //f5
		txt.key("f5");
		ev.preventDefault();
		return false;
	case 117:  //f6
		txt.key("f6");
		ev.preventDefault();
		return false;
	case 118:  //f7
		txt.key("f7");
		ev.preventDefault();
		return false;
	case 119:  //f8
		txt.key("f8");
		ev.preventDefault();
		return false;
	case 120:  //f9
		txt.key("f9");
		ev.preventDefault();
		return false;
	case 121:  //f10
		txt.key("f10");
		ev.preventDefault();
		return false;
	case 122:  //f11
		txt.key("f11");
		ev.preventDefault();
		return false;
	case 123:  //f12
		txt.key("f12");
		ev.preventDefault();
		return false;
	}
}
function KeyPress(ev) {
	txt.key(ev.charCode);
	ev.preventDefault();
	return false;
}
function Reset() {
	o1.step=o2.step=o3.step=o4.step=o5.step=o6.step=o7.step=o8.step=0;
	bdo.step=sdo.step=hho.step=cyo.step=0;
	cnt=0;
	lfo1=lfo2=lfo4=lfo8=lfo16=lfo32=lfo48=lfo64=0;
}
function Enter(s) {
	var r="";
	txt.log.unshift("> "+s);
	txt.log.length=txt.rows;
	if(s.indexOf("//")==0)
		return "";
	var n=0;
	for(var i=s.length-1;i>=0;--i)
		if(s[i]=="\"")
			++n;
	if(n&1)
		s+="\"";
	var ss=s.split(";");
	for(var idx=0;idx<ss.length;++idx) {
		s=ss[idx];
		r+=Enter1(s);
	}
	return r;
}
function oscdesc(o,nam) {
	var r;
	r=nam+".s (note):"+o.s+"\n";
	r+=nam+".g (gate):"+o.g+"\n";
	r+=nam+".v (volume):"+o.v+"\n";
	r+=nam+".f (freq):"+o.f+"\n";
	r+=nam+".c (cutoff):"+o.c+"\n";
	r+=nam+".q (Q):"+o.q+"\n";
	r+=nam+".delay:"+o.delay+"\n";
	r+=nam+".pan:"+o.pan+"\n";
	r+=nam+".out:"+o.out+"\n";
	return r;
}
function fmodesc(o,nam) {
	var r;
	r=nam+".s (step):"+o.s+"\n";
	r+=nam+".v (volume):"+o.v+"\n";
	r+=nam+".pan:"+o.pan;
	return r;
}
function Parse0(s) {
	function Parse1(l,r) {
		var o=null;
		var fmo=null;
		for(var i=0;i<plugins.length;++i) {
			var p=plugins[i];
			var pparam=pluginsparam[i];
			var pparamval=pluginsparamval[i];
			if(l.indexOf(p.name+".")==0) {
				var pname=l.substr(p.name.length+1);
				if(pname.length==1) {
					pparam[pname]=r;
				}
				else {
					for(var j in p.obj.param) {
						if(l==p.name+"."+j)
							pparam[j]=r;
					}
				}
			}
		}
		if(l.indexOf("bdo.")==0)
			fmo=bdo;
		else if(l.indexOf("sdo.")==0)
			fmo=sdo;
		else if(l.indexOf("hho.")==0)
			fmo=hho;
		else if(l.indexOf("cyo.")==0)
			fmo=cyo;
		if(fmo) {
			switch(l.substr(4)) {
			case "s": fmo.s=right; break;
			case "s+": fmo.s=streval(fmo.s)+streval(right); break;
			case "v": fmo.v=right; break;
			case "pan": fmo.pan=right; break;
			default: return "Property not found";
			}
			return null;
		}
		if(l[0]=="o" && l[2]==".") {
			switch(l[1]) {
			case "1": o=o1; break;
			case "2": o=o2; break;
			case "3": o=o3; break;
			case "4": o=o4; break;
			case "5": o=o5; break;
			case "6": o=o6; break;
			case "7": o=o7; break;
			case "8": o=o8; break;
			}
			if(o) {
				switch(l.substr(3)) {
				case "s": o.s=right; break;
				case "s+": o.s=streval(o.s)+streval(right); break;
				case "g": o.g=right; break;
				case "g+": o.g=streval(o.g)+streval(right); break;
				case "f": o.f=right; break;
				case "v": o.v=right; break;
				case "c": o.c=right; break;
				case "q": o.q=right; break;
				case "type": o.type=right; break;
				case "delay": o.delay=right; break;
				case "pan": o.pan=right; break;
				case "out": o.out=right; break;
				default: return "Property not found";
				}
				return null;
			}
		}
		switch(l) {
		case "master.v": master.v=r; break;
		case "master.g": master.g=r; break;
		case "master.tempo": master.tempo=r; break;
		case "master.rev": master.rev=r; break;
		case "master.ir": master.ir=numeval(r);
			if(master.ir>=1)
				master.conv.buffer=ir[master.ir-1].data;
			break;
		case "delay.t": delay.t=r; break;
		case "delay.fb": delay.fb=r; break;
		case "txt.a": txt.a=r; break;
		case "txt.w": txt.w=r; break;
		case "txt.h": txt.h=r; break;
		case "txt.x": txt.x=r; break;
		case "txt.y": txt.y=r; break;
		case "txt.z": txt.z=r; break;
		case "txt.rot": txt.rot=r; break;
		case "txt.eff": txt.eff=r; break;
		case "txt.col": txt.col=r; break;
		case "txt.bcol": txt.bcol=r; break;
		case "cam.v": cam.v=r; break;
		case "cam.q": cam.q=r; break;
		case "cam.c": cam.c=r; break;
		case "cam.f": cam.f=r; break;
		case "cam.g": cam.g=r; break;
		case "cam.delay": cam.delay=r; break;
		case "cam.porta": cam.porta=r; break;
		case "cam.scale": cam.scale=r; cam.notes=Mml(cam.scale); break;
		case "cam.midi": cam.midi=r; break;
		case "cam.a": cam.a=r; break;
		case "cam.type": cam.type=r; break;
		case "cam.w": cam.w=r; break;
		case "cam.h": cam.h=r; break;
		case "cam.x": cam.x=r; break;
		case "cam.y": cam.y=r; break;
		case "cam.z": cam.z=r; break;
		case "cam.rot": cam.rot=r; break;
		case "cam.eff": cam.eff=r; break;
		case "cam.effb": cam.effb=r; break;
		default: return "Object not found";
		}
		return null;
	}
	var v=s.split("=");
	var right=v[v.length-1];
	var r;
	for(var i=v.length-2;i>=0;--i) {
		r=Parse1(v[i],right);
		if(r)
			break;
	}
	if(r)
		return r;
	else
		return right;
}
function Parse(str) {
	function isspc(p) {
		if(str[p]==" "||p>=str.length)
			return true;
		return false;
	}
	function skip(p) {
		while(p<str.length&&isspc(p))
			++p;
		return p;
	}
	function test(p,s) {
		if(str.indexOf(s,p)==p&&isspc(p+s.length))
			return true;
		return false;
	}
	var p=0;
	p=skip(p);
	if(test(p,"clear")) {
		txt.log=[];
		return "";
	}
	if(test(p,"print")) {
		var s;
		p=skip(p+5);
		s=str.substr(p);
		try {
			s=eval(s)+"\n";
		} catch(e) {s="Undefined\n";}
		return s;
	}
	if(test(p,"list")) {
		var r="";
		p=skip(p+4);
		if(test(p,"plugins")) {
			for(var i=0;i<plugins.length;++i) {
				r+=plugins[i].name+":"+plugins[i].script+"\n";
			}
			return r;
		}
		for(var i=0;i<plugins.length;++i) {
			if(test(p,plugins[i].name)) {
				r+=plugins[i].name+":\n";
				for(var j in plugins[i].obj.param) {
					r+=" "+j+":"+plugins[i].obj.param[j].value+"\n";
				}
				return r;
			}
		}
		if(test(p,"ir")) {
			for(var i=0;i<ir.length;++i) {
				r+=(i+1)+":"+ir[i].name+"\n";
			}
			return r;
		}
		if(test(p,"midi")) {
			for(var i=0;i<midioutputs.length;++i) {
				r+=(i+1)+":"+midioutputs[i].name+"\n";
			}
			return r;
		}
		if(test(p,"osc")) {
			r="o1.s:"+o1.s;
			r+="\no2.s:"+o2.s;
			r+="\no3.s:"+o3.s;
			r+="\no4.s:"+o4.s;
			r+="\no5.s:"+o5.s;
			r+="\no6.s:"+o6.s;
			r+="\no7.s:"+o7.s;
			r+="\no8.s:"+o8.s+"\n";
			return r;
		}
		if(test(p,"fmo")) {
			r="cyo.s:"+cyo.s;
			r+="\nhho.s:"+hho.s;
			r+="\nsdo.s:"+sdo.s;
			r+="\nbdo.s:"+bdo.s+"\n";
			return r;
		}
		if(test(p,"master")) {
			r="master.v (volume):"+master.v+"\n";
			r+="master.g (gate):"+master.g+"\n";
			r+="master.tempo:"+master.tempo+"\n";
			r+="master.rev:"+master.rev+"\n";
			r+="master.ir:"+master.ir+"\n";
			return r;
		}
		if(test(p,"delay")) {
			r="delay.t (time):"+delay.t+"\n";
			r+="delay.fb (feedback):"+delay.fb+"\n";
			return r;
		}
		if(test(p,"txt")) {
			r="txt.a (alpha):"+txt.a+"\n";
			r+="txt.w (width):"+txt.w+"\n";
			r+="txt.h (height):"+txt.h+"\n";
			r+="txt.x (pos x):"+txt.x+"\n";
			r+="txt.y (pos y):"+txt.y+"\n";
			r+="txt.z (zoom):"+txt.z+"\n";
			r+="txt.rot (rotate):"+txt.rot+"\n";
			r+="txt.eff (effect):"+txt.eff+"\n";
			r+="txt.col (color):"+txt.col+"\n";
			return r;
		}
		if(test(p,"cam")) {
			r="cam.v (volume):"+cam.v+"\n";
			r+="cam.q:"+cam.q+"\n";
			r+="cam.delay (delay):"+cam.delay+"\n";
			r+="cam.porta (portament):"+cam.porta+"\n";
			r+="cam.scale:"+cam.scale+"\n";
			r+="cam.midi (midiport):"+cam.midi+"\n";
			r+="cam.a (alpha):"+cam.a+"\n";
			r+="cam.type (video-type):"+cam.type+"\n";
			r+="cam.w (width):"+cam.w+"\n";
			r+="cam.h (height):"+cam.h+"\n";
			r+="cam.x (pos x):"+cam.x+"\n";
			r+="cam.y (pos y):"+cam.y+"\n";
			r+="cam.z (zoom):"+cam.z+"\n";
			r+="cam.rot (rotate):"+cam.rot+"\n";
			r+="cam.eff (effect):"+cam.eff+"\n";
			return r;
		}
		if(test(p,"o1"))
			return oscdesc(o1,"o1");
		if(test(p,"o2"))
			return oscdesc(o2,"o2");
		if(test(p,"o3"))
			return oscdesc(o3,"o3");
		if(test(p,"o4"))
			return oscdesc(o4,"o4");
		if(test(p,"o5"))
			return oscdesc(o5,"o5");
		if(test(p,"o6"))
			return oscdesc(o6,"o6");
		if(test(p,"o7"))
			return oscdesc(o7,"o7");
		if(test(p,"o8"))
			return oscdesc(o8,"o8");
		if(test(p,"bdo"))
			return fmodesc(bdo,"bdo");
		if(test(p,"sdo"))
			return fmodesc(sdo,"sdo");
		if(test(p,"hho"))
			return fmodesc(hho,"hho");
		if(test(p,"cyo"))
			return fmodesc(cyo,"cyo");
		r="";
		r+="--builtin--\n";
		r+="master, delay, txt, cam\n";
		r+="osc:o1 o2 o3 o4 o5 o6 o7 o8\n";
		r+="fmo:bdo sdo hho cyo\n";
		r+="--variables--\ns0-s24:pre-defined sequence\ntick:currentTick\nlev:currentLevel\nsh8/16/32/64: S&H/(n)tick\n";
		r+="lfo8/16/32/64: LFO (n)tick\n";
		r+="--functions--\nhue(): for colorString\nlfo(n): (n)tickLFO\n";
		r+="--plugins--\nwav,mat\n";
		return r;
	}
	return null;
}
function Enter1(s) {
	var v=Parse(s);
	if(v!==null)
		return v;
	return Parse0(s);
}
function Mml(s) {
	function GetN(def) {
		var v=0;
		while(s[p]>="0"&&s[p]<="9") {
			v=v*10+s[p];
			++p;
		}
		if(v==0)
			return def;
		return v;
	}
	function GetLen(def) {
		var l=16/GetN(def);
		var l2=l;
		while(s[p]==".") {
			++p;
			l2/=2;
			l+=l2;
		}
		return l;
	}
	function Shift(n) {
		for(;;) {
			switch(s[p]) {
			case "+": case "#":
				++p;
				++n;
				break;
			case "-":
				++p;
				--n;
			default:
				return n;
			}
		}
	}
	var r=[];
	var len=s.length;
	var p=0;
	var n=0;
	var o=4;
	var l=0;
	var defl=16;
	while(p<len) {
		l=0;
		switch(s[p]) {
		case ">":
			++p;
			--o;
			break;
		case "<":
			++p;
			++o;
			break;
		case "O": case "o":
			++p;
			o=GetN(4);
			break;
		case "L": case "l":
			++p;
			defl=GetN(16);
			break;
		case "R": case "r":
			++p;
			n=0;
			l=GetLen(defl);
			break;
		case "C": case "c":
			++p;
			n=Shift(o*12);
			l=GetLen(defl);
			break;
		case "D": case "d":
			++p;
			n=Shift(o*12+2);
			l=GetLen(defl);
			break;
		case "E": case "e":
			++p;
			n=Shift(o*12+4);
			l=GetLen(defl);
			break;
		case "F": case "f":
			++p;
			n=Shift(o*12+5);
			l=GetLen(defl);
			break;
		case "G": case "g":
			++p;
			n=Shift(o*12+7);
			l=GetLen(defl);
			break;
		case "A": case "a":
			++p;
			n=Shift(o*12+9);
			l=GetLen(defl);
			break;
		case "B": case "b":
			++p;
			n=Shift(o*12+11);
			l=GetLen(defl);
			break;
		default:
			++p;
		}
		for(var i=0;i<l;++i)
			r.push(n);
	}
	if(r.length==0)
		return [0];
	return r;
}
function Timecode(t) {
	var hh=(t/3600)|0;
	t-=hh*3600;
	var mm=(t/60)|0;
	t-=mm*60;
	var ss=t|0;
	var ff=((t-ss)*30)|0;
	return ("00"+hh).substr(-2)+":"+("00"+mm).substr(-2)+":"+("00"+ss).substr(-2)+":"+("00"+ff).substr(-2);
}
function Interval() {
	var current=audio.currentTime;
	var err;
	if(current>=nextTime-.1) {
		document.getElementById("timecode").innerHTML=Timecode(current);
		++tick;
		master.next(nextTime);
		bdo.next(nextTime);
		sdo.next(nextTime);
		hho.next(nextTime);
		cyo.next(nextTime);
		o1.next(nextTime);
		o2.next(nextTime);
		o3.next(nextTime);
		o4.next(nextTime);
		o5.next(nextTime);
		o6.next(nextTime);
		o7.next(nextTime);
		o8.next(nextTime);
		delay.next(nextTime);
		var c4=tick&3;
		var c8=tick&7;
		var c16=tick&15;
		var c32=tick&31;
		var c64=tick&63;
		var c96=tick%96;
		var c128=tick&127;
		lfo1=cnt&1;
		lfo2=((c4>2)?4-c4:c4)*.5;
		lfo4=((c8>4)?8-c8:c8)*.25;
		lfo8=((c16>8)?16-c16:c16)*.125;
		lfo16=((c32>16)?32-c32:c32)*.0625;
		lfo32=((c64>32)?64-c64:c64)*.03125;
		lfo48=((c96>48)?96-c96:c96)/48;
		lfo64=((c128>64)?128-c128:c128)*.015625;
		if((tick&1)==0) sh1=Math.random();
		if(c4==0) sh2=Math.random();
		if(c8==0) sh4=Math.random();
		if(c16==0) sh8=Math.random();
		if(c32==0) sh16=Math.random();
		if(c64==0) sh32=Math.random();
		if(c96==0) sh48=Math.random();
		if(c128==0) sh64=Math.random();
		var a=0;
		for(var i=0;i<512;++i) {
			var t=wavdat[i]-128;
			a+=t*t;
		}
		lev=Math.sqrt(a/512)/256;
		txt.next();
		cam.next();
		txt.layout();
		cam.layout();
		txt.draw();
		cam.draw();
		if(nextTime==0)
			nextTime=current;
		do {
			nextTime=nextTime+15/master._tempo;
		} while(nextTime<current);
	}
}
function lfo(t) {
	var l=t|0;
	var l2=l/2;
	var p=tick%l;
	p=(p>=l2)?l-p:p;
	return p/l2;
}
function hsv(h,s,v) {
	h=h-(h|0);
	if(s>1) s=s-(s|0);
	if(v>1) v=v-(v|0);
	var r=v,g=v,b=v;
	if(s>0) {
		h*=6.0;
		var hh=h|0;
		var f=h-hh;
		var r,g,b;
		switch(hh) {
		case 0:
			g=v-v*s*(1-f);
			b=v-v*s;
			break;
		case 1:
			r=v-v*s*f;
			b=v-v*s;
			break;
		case 2:
			r=v-v*s;
			b=v-v*s*(1-f);
			break;
		case 3:
			r=v-v*s;
			g=v-v*s*f;
			break;
		case 4:
			r=v-v*s*(1-f);
			g=v-v*s;
			break;
		case 5:
			g=v-v*s;
			b=v-v*s*f;
			break;
		}
	}
	return "rgb("+(r*255|0)+","+(g*255|0)+","+(b*255|0)+")";
}
function hue(h) {
	h-=(h|0);
	var t=h*6;
	var r=g=b=0;
	if(t<1) {
		r=255;
		g=(t*255)|0;
		b=0;
	}
	else if(t<2) {
		r=((2-t)*255)|0;
		g=255;
		b=0;
	}
	else if(t<3) {
		r=0;
		g=255;
		b=((t-2)*255)|0;
	}
	else if(t<4) {
		r=0;
		g=((4-t)*255)|0;
		b=255;
	}
	else if(t<5) {
		r=((t-4)*255)|0;
		g=0;
		b=255;
	}
	else {
		r=255;
		g=0;
		b=((6-t)*255)|0;
	}
	return "rgb("+r+","+g+","+b+")";
}
function streval(s) {
	if(s=="s") return s;
	if(s=="l") return s;
	var l=s;
	for(;;) {
		if(typeof(s)=="string") {
			l=s;
			try {
				s=eval(s);
			} catch(e) {return l;}
		}
		else
			return l;
	}
}
function numeval(s) {
	try {
		for(;;) {
			var t=typeof(s);
			switch(t) {
			case "number":
				return s;
			case "string":
				s=eval(s);
				break;
			default:
				return 0;
			}
		}
	} catch(e) {return 0;}
}
function Note2Vol(n) {
	n-=48;
	if(n<0)
		return 0;
	return 2/(n+2); 
}
function Noise() {
	this.scr=audio.createScriptProcessor(1024,1,1);
	this.Process=function(ev) {
		Interval();
//		var buf=ev.getChannelData(0);
//		for(var i=0;i<1024;++i)
//			buf.data[i]=Math.random()*.5;
	};
	this.scr.onaudioprocess=this.Process;
	this.scr.connect(out);
}
function OSC(f,v,t,to) {
	this.ena=0;
	this.form={0:"sine",1:"sawtooth",2:"square"};
	this.Osc=audio.createOscillator();
	this.Fil=audio.createBiquadFilter();
	this.Gain=audio.createGain();
	this.Mod=audio.createGain();
	this.Send=audio.createGain();
	this.Pan=audio.createPanner();
	this.Osc.connect(this.Fil);
	this.Fil.connect(this.Gain);
	this.Gain.connect(this.Mod);
	this.Gain.connect(this.Send);
	this.Send.connect(delay.Dly);
	this.Gain.connect(this.Pan);
	this.Gain.connect(this.Mod);
	this.Gain.gain.value=0;
	this.Send.gain.value=0;
	this.Mod.gain.value=1000;
	this.Pan.panningModel="equalpower";
	if(to) {
		this.Pan.connect(to);
	}
	this.s="r";
	this.g="c";
	this.type=t;
	this.c=20;
	this.q=10;
	this.v=v;
	this.pan=.5;
	this.step=0;
	this._out=null;
	this.out="master";
	this.freq="";
	this.delay=0.0;
	this.f=f;
	this.Osc.start(0);
	this.next=function(t) {
		this.Send.gain.value=this.delay;
		this.Osc.type=this.form[numeval(this.type)];
		var s=Mml(streval(this.s));
		this.step=tick%s.length;
		var tune=s[this.step];
		var g=Mml(streval(this.g));
		var v=Note2Vol(g[tick%g.length]);
		if(this._out!=this.out) {
			this._out=this.out;
			this.Pan.disconnect();
			this.Mod.disconnect();
			if(this._out=="master")
				this.Pan.connect(master.out);
			else {
				this.Gain.connect(this.Mod);
				try {
					this.Mod.connect(eval(this.out).Osc.frequency);
				} catch(e) {}
			}
		}
		if(tune) {
			tune=(tune-57)*100;
			this.Osc.detune.setValueAtTime(tune,t);
			this.Fil.detune.setValueAtTime(tune,t);
			var _freq=numeval(this.f);
			this.Osc.frequency.setValueAtTime(_freq,t);
			var _cutoff=numeval(this.c);
			this.Fil.frequency.setValueAtTime(_freq*_cutoff,t);
			this.Fil.Q.value=numeval(this.q);
			this.Gain.gain.setTargetAtTime(numeval(this.v)*v,t,0.001);
		}
		else {
			this.Gain.gain.setTargetAtTime(0,t,0.01);
		}
		var th=Math.PI*(numeval(this.pan)-.5);
		this.Pan.setPosition(Math.sin(th),0,-Math.cos(th));
	}
}
function FMO(f1,v1,r1,t1,f2,v2,r2,t2,f3,v3,r3,t3,p) {
	this.Op1=audio.createOscillator();
	this.Op1gain=audio.createGain();
	this.Op2=audio.createOscillator();
	this.Op2gain=audio.createGain();
	this.Op3=audio.createOscillator();
	this.Op3gain=audio.createGain();
	this.Pan=audio.createPanner();
	this.Pan.panningModel="equalpower";
	this.form={0:"sine",1:"sawtooth",2:"square"};

	this.Op3.connect(this.Op3gain);
	this.Op3gain.connect(this.Op2.frequency);
	this.Op2.connect(this.Op2gain);
	this.Op2gain.connect(this.Op1.frequency);
	this.Op1.connect(this.Op1gain);
	this.Op1gain.connect(this.Pan);
	this.Pan.connect(master.out);
	this.Op1gain.gain.value=0;
	this.s="r";
	this.step=0;
	this.f1=f1;
	this._v=this.v=v1;
	this.r1=r1;
	this.f2=f2;
	this.v2=v2;
	this.r2=r2;
	this.f3=f3;
	this.v3=v3;
	this.r3=r3;
	this.pan=p;
	this.Op1.start(0);
	this.Op2.start(0);
	this.Op3.start(0);
	this.Op1.frequency.value=f1;
	this.Op2.frequency.value=f2;
	this.Op3.frequency.value=f3;
	this.Op1.type=this.form[t1];
	this.Op2.type=this.form[t2];
	this.Op3.type=this.form[t3];
	this.trig=function(t) {
		this.Op1gain.gain.setValueAtTime(this._v,t);
		this.Op2gain.gain.setValueAtTime(this.v2,t);
		this.Op3gain.gain.setValueAtTime(this.v3,t);
		this.Op1gain.gain.setTargetAtTime(0,t+0.01,this.r1);
		this.Op2gain.gain.setTargetAtTime(0,t+0.01,this.r2);
		this.Op3gain.gain.setTargetAtTime(0,t+0.01,this.r3);
	}
	this.next=function(t) {
		var s=Mml(streval(this.s));
		this.step=tick%s.length;
		var c=s[this.step];
		this._v=numeval(this.v);
		if(c) {
			var n=(c-48)*100;
			this.Op1.detune.value=n;
			this.trig(t);
		}
		var th=Math.PI*(numeval(this.pan)-.5);
		this.Pan.setPosition(Math.sin(th),0,-Math.cos(th));
	}
}
function Master() {
	function GetName(s) {
		var p=s.lastIndexOf("/");
		return s.substr(p+1);
	}
	function LoadSample(n,url) {
		var req = new XMLHttpRequest();
		req.open("GET", url, true);
		req.responseType = "arraybuffer";
		req.nam=GetName(url);
		req.onload = function() {
			if(req.response) {
				audio.decodeAudioData(req.response,function(b){ir[n]={"name":req.nam,"data":b};},function(){});
			}
		}
		req.onerror=function() {
			window.xhrreqerr=true;
		}
		try {req.send();} catch(e){}
	}
	LoadSample(0,"samples/IMreverbs1/Five Columns Long.wav");
	LoadSample(1,"samples/IMreverbs1/Five Columns.wav");
	LoadSample(2,"samples/IMreverbs1/French 18th Century Salon.wav");
	LoadSample(3,"samples/IMreverbs1/Going Home.wav");
	LoadSample(4,"samples/IMreverbs1/In The Silo Revised.wav");
	LoadSample(5,"samples/IMreverbs1/Narrow Bumpy Space.wav");
	LoadSample(6,"samples/IMreverbs1/Nice Drum Room.wav");
	LoadSample(7,"samples/IMreverbs1/Parking Garage.wav");
	LoadSample(8,"samples/IMreverbs1/Rays.wav");
	LoadSample(9,"samples/IMreverbs1/Trig Room.wav");

	this.v=this._v=1.0;
	this.fade=.1;
	this.conv=audio.createConvolver();
	this.convgain=audio.createGain();
	this.comp=audio.createDynamicsCompressor();
	this.out=audio.createGain();
	this.ana=audio.createAnalyser();
	this.ana.fftSize=1024;
	this.out.connect(this.conv);
	this.out.connect(this.comp);
	this.conv.connect(this.convgain);
	this.convgain.connect(this.comp);
	this.comp.connect(audio.destination);
	this.comp.connect(this.ana);
	this.g="c";
	this.ir=0;
	this._rev=this.rev=.5;
	this._tempo=this.tempo=120;
	this.step=0;
	this.next=function(t) {
		this._tempo=numeval(this.tempo);
		var g=Mml(streval(this.g));
		var v=Note2Vol(g[tick%g.length]);
		var _v=numeval(this.v);
		this._rev=numeval(this.rev);
		this.convgain.gain.value=this._rev;
		this._v+=(_v-this._v)*this.fade;
		this.out.gain.setValueAtTime(this._v*v,t);
	}
}
function Delay() {
	this.Dly=audio.createDelay();
	this.Dly.delayTime.value=60/master._tempo;
	this.Fb=audio.createGain();
	this.Fb.gain.value=.5;
	this.Dly.connect(this.Fb);
	this.Dly.connect(out);
	this.Fb.connect(this.Dly)
	this.t=8;
	this.fb=.5;
	this.next=function() {
		var n=4/numeval(this.t);
		this.Fb.gain.value=numeval(this.fb);
		this.Dly.delayTime.value=60*n/master._tempo+0.02;
	}
}
function Midi() {
	console.log("---MIDI---");
	this.onMIDIFailure=function(msg) {console.log(msg);};
	this.onMIDISuccess=function(ac) {
		midioutputs=ac.outputs();
		console.log("number of midi ports:"+midioutputs.length);
	};
	if(navigator.requestMIDIAccess) {
		navigator.requestMIDIAccess().then(this.onMIDISuccess,this.onMIDIFailure);
		this.setup=function(midiout) {
			if(midiout) {
				midiout.send([0xb0,70,125]);	//detune
				midiout.send([0xb0,76,55]);	//lfo rate
			}
		}
	}
}
function Txt() {
	this.a=this._a=1.0;
	this.v=this._v=0.0;
	this.w=this._w=1.0;
	this.h=this._h=1.0;
	this.x=this._x=0.5;
	this.y=this._y=0.5;
	this.z=this._z=1.0
	this.eff=0;
	this.rot=this._rot=0;
	this.fade=0.5;
	this.cmdline="";
	this.cursor=0;
	this.log=[];
	this.hist=[];
	this.histcur=0;
	this._col=this.col="#0f0";
	this._bcol=this.bcol="#000";
	this.rx=640;
	this.ry=480;
	this.yheight=400;
	this.rows=25;
	this.mry=(this.yheight/this.rows)|0;
	this.cvtxt=document.getElementById("cvtxt");
	this.cvtxt.width=this.rx;
	this.cvtxt.height=this.ry;
	this.ctxtxt=this.cvtxt.getContext("2d");
	this.cvtxtwork=document.getElementById("cvtxtwork");
	this.cvtxtwork.width=this.rx;
	this.cvtxtwork.height=this.ry;
	this.ctxtxtwork=this.cvtxtwork.getContext("2d");
	this.ctxtxtwork.lineWidth=6;
	this.ctxtxtwork.font="bold "+this.mry+"px Courier,monospace";
	this.mrx=this.ctxtxtwork.measureText("M").width;

	this.layout=function() {
		var w=scrWidth*this._w*this._z;
		var h=scrHeight*this._h*this._z;
		var x=scrWidth*this._x-w*.5;
		var y=scrHeight*this._y-h*.5;
		this.cvtxt.style.opacity=this._a;
		this.cvtxt.style.width=w+"px";
		this.cvtxt.style.height=h+"px";
		this.cvtxt.style.left=x+"px";
		this.cvtxt.style.top=y+"px";
		this.cvtxt.style.WebkitTransform="rotate("+this._rot+"deg)";
		this.cvtxt.style.MozTransform="rotate("+this._rot+"deg)";
	}
	this.next=function() {
		this._a+=(numeval(this.a)-this._a)*this.fade;
		this._v+=(numeval(this.v)-this._v)*this.fade;
		this._w+=(numeval(this.w)-this._w)*this.fade;
		this._h+=(numeval(this.h)-this._h)*this.fade;
		this._x+=(numeval(this.x)-this._x)*this.fade;
		this._y+=(numeval(this.y)-this._y)*this.fade;
		this._z+=(numeval(this.z)-this._z)*this.fade;
		this._rot+=(numeval(this.rot)-this._rot)*this.fade;
		this._eff=numeval(this.eff);
		this._col=streval(this.col);
		this._bcol=streval(this.bcol);
	}
	this.draw=function() {
		this.ctxtxtwork.clearRect(0,0,this.rx,this.ry);
		this.ctxtxtwork.strokeStyle=this._bcol;
		this.ctxtxtwork.fillStyle=this._col;
		var i;
		for(i=0;i<this.rows;++i) {
			var s=this.log[i];
			if(!s)
				s="";
			this.ctxtxtwork.strokeText(s,10,this.yheight-(i+1)*this.mry);
			this.ctxtxtwork.fillText(s,10,this.yheight-(i+1)*this.mry);
		}
		var cmd="> "+this.cmdline;
		this.ctxtxtwork.strokeText(cmd,10,this.yheight);
		this.ctxtxtwork.fillText(cmd,10,this.yheight);
		if(tick&1) {
			var m=this.ctxtxtwork.measureText(cmd);
			this.ctxtxtwork.beginPath();
			this.ctxtxtwork.rect(m.width+10,this.yheight-this.mry+4,this.mrx,this.mry);
			this.ctxtxtwork.stroke();
			this.ctxtxtwork.fillRect(m.width+10,this.yheight-this.mry+4,this.mrx,this.mry);
		}
		this.ctxtxt.clearRect(0,0,this.rx,this.ry);
		for(i=0;i<this.ry;++i) {
//			this.ctxtxt.globalAlpha=Math.max(0.5,Math.min(1,0.5+(wavdat[i]-128)*0.2*this._eff));
			this.ctxtxt.drawImage(this.cvtxtwork,0,i,this.rx,1,wavdat[i]*this._eff,i,this.rx,1);
		}
	}
	this.message=function(mess) {
		this.log.unshift(mess+"");
		if(this.log.length>this.rows)
			this.log.length=this.rows;
	}
	this.key=function(k) {
		switch(k) {
		case "l":
			return;
		case "u":
			if(this.histcur<this.hist.length-1) {
				++this.histcur;
				this.cmdline=this.hist[this.histcur];
				this.cursor=this.cmdline.length;
			}
			return;
		case "r":
			return;
		case "d":
			if(this.histcur>=0) {
				--this.histcur;
				if(this.histcur==-1) {
					this.cmdline="";
					this.cursor=0;
				}
				else {
					this.cmdline=this.hist[this.histcur];
					this.cursor=this.cmdline.length;
				}

			}
			return;
		case "f1":
			this.cmdline=fn[0];
			this.cursor=this.cmdline.length;
			return;
		case "f2":
			this.cmdline=fn[1];
			this.cursor=this.cmdline.length;
			return;
		case "f3":
			this.cmdline=fn[2];
			this.cursor=this.cmdline.length;
			return;
		case "f4":
			this.cmdline=fn[3];
			this.cursor=this.cmdline.length;
			return;
		case "f5":
			this.cmdline=fn[4];
			this.cursor=this.cmdline.length;
			return;
		case "f6":
			this.cmdline=fn[5];
			this.cursor=this.cmdline.length;
			return;
		case "f7":
			this.cmdline=fn[6];
			this.cursor=this.cmdline.length;
			return;
		case "f8":
			this.cmdline=fn[7];
			this.cursor=this.cmdline.length;
			return;
		case "f9":
			this.cmdline=fn[8];
			this.cursor=this.cmdline.length;
			return;
		case "f10":
			this.cmdline=fn[9];
			this.cursor=this.cmdline.length;
			return;
		case "f11":
			this.cmdline=fn[10];
			this.cursor=this.cmdline.length;
			return;
		case "f12":
			this.cmdline=fn[11];
			this.cursor=this.cmdline.length;
			return;
		case 8:
			if(this.cursor) {
				this.cmdline=this.cmdline.slice(0,-1);
				--this.cursor;
			}
			return;
		case 13:
			this.histcur=-1;
			this.hist.unshift(this.cmdline);
			if(this.hist.length>10)
				this.hist.length=10;
			var s=Enter(this.cmdline);
			this.cmdline="";
			this.cursor=0;
			if(s!=undefined) {
				var ss=(s+"").split("\n");
				for(ii=0;ii<ss.length-1;++ii) {
					this.log.unshift(ss[ii]);
					this.log.length=this.rows;
				}
			}
			return;
		}
		var s=String.fromCharCode(k);
		this.cmdline+=s;
		this.cursor=this.cmdline.length;
		this.histcur=-1;
	}
}
function Cam() {
	this.imgdatframe=[null,null];
	this.imgdatcam=null;
	this.frame=0;
	this.levx=new Array(320);
	this.levy=new Array(240);
	this.scrdiff=new Array(320*240);
	this.eff=1;
	this.curvol=0;
	this._q=this.q=5;
	this._f=this.f=440;
	this._c=this.c=32;
	this.a=this._a=0;
	this.type=this._type=0;
	this.v=this._v=0;
	this.w=this._w=1.0;
	this.h=this._h=1.0;
	this.x=this._x=0.5;
	this.y=this._y=0.5;
	this.z=this._z=1.0;
	this.rot=this._rot=0;
	this.delay=0;
	this.fade=0.5;
	this.video=document.getElementById("video");
	this.cvcam=document.getElementById("cvcam");
	this.cvcamwork=document.getElementById("cvcamwork");
	this.ctxcam=cvcam.getContext("2d");
	this.ctxcamwork=cvcamwork.getContext("2d");
	this.Osc=audio.createOscillator();
	this.Fil=audio.createBiquadFilter();
	this.Lfo=audio.createOscillator();
	this.LfoGain=audio.createGain();
	this.Gain=audio.createGain();
	this.Send=audio.createGain();
	this.Send.gain.value=0;
	this.Gain.gain.value=0;
	this.Osc.connect(this.Fil);
	this.Lfo.connect(this.LfoGain);
	this.LfoGain.connect(this.Osc.detune);
	this.Fil.connect(this.Gain);
	this.Gain.connect(this.Send);
	this.Gain.connect(out);
	this.Send.connect(delay.Dly);
	this.Osc.type="square";
	this.Lfo.type="sine";
	this.Osc.frequency.value=440;
	this.Lfo.frequency.value=6;
	this.Fil.frequency.value=4400;
	this.Fil.Q.value=this.q;
	this.LfoGain.gain.value=0;
	this.Lfo.start(0);
	this.Osc.start(0);
	this.midi=0;
	this._midi=0;
	this.effb=this._effb=0;
	this.porta=0.05;
	this.px=0;
	this.midipitch=0;
	this.scale="cdega<cdega<c";
	this.g="c";
	this.notes=Mml(this.scale);
	this.layout=function() {
		var w=scrWidth*this._w*this._z;
		var h=scrHeight*this._h*this._z;
		var x=scrWidth*this._x-w*.5;
		var y=scrHeight*this._y-h*.5;
		this.cvcam.style.opacity=this._a;
		this.cvcam.style.width=w+"px";
		this.cvcam.style.height=h+"px";
		this.cvcam.style.left=x+"px";
		this.cvcam.style.top=y+"px";
		cvcam.style.WebkitTransform="rotate("+this._rot+"deg)";
		cvcam.style.WebkitFilter="blur("+this._effb+"px)";
	}
	this.next=function() {
		this._g=Mml(streval(this.g));
		this.gate=Note2Vol(this._g[tick%this._g.length]);
		this._a+=(numeval(this.a)-this._a)*this.fade;
		this._v+=(numeval(this.v)-this._v)*this.fade;
		this._w+=(numeval(this.w)-this._w)*this.fade;
		this._h+=(numeval(this.h)-this._h)*this.fade;
		this._x+=(numeval(this.x)-this._x)*this.fade;
		this._y+=(numeval(this.y)-this._y)*this.fade;
		this._z+=(numeval(this.z)-this._z)*this.fade;
		this._rot+=(numeval(this.rot)-this._rot)*this.fade;
		this._f=numeval(this.f);
		this._q=numeval(this.q);
		this._c=numeval(this.c);
		this._eff=numeval(this.eff);
		this._effb=numeval(this.effb);
		this._type=numeval(this.type);
	}
	this.draw=function() {
		var oframe=this.frame^1;
		var px,py,x,y;
		var note;
		var freq;
		var avex=0;
		var avey=0;
		var sumpx=0;
		var sumpy=0;
		var cntpx=0;
		var avex=0;
		var avey=0;
		var vol=0;
		var r,g,b,dr,dg,db;
		px=0;
		py=0;
		this.ctxcamwork.drawImage(this.video,0,0,320,240);
		this.imgdatframe[this.frame]=this.ctxcamwork.getImageData(0,0,320,240);
		if(this.imgdatframe[this.frame]&&this.imgdatframe[oframe]) {
			var cpix=this.imgdatframe[this.frame].data;
			var opix=this.imgdatframe[oframe].data;
			var dpix=this.imgdatcam.data;
			var t=this._type;
			for(i=0;i<320;++i)
				this.levx[i]=0;
			for(i=0;i<240;++i)
				this.levy[i]=0;
			for(var y=0;y<240;++y) {
				var offs=y*320;
				var offs4=offs*4;
				var roffs4=(offs+320-1)*4;
				var soffs4;
				var cr,cg,cb,r,g,b,diff,v;
				for(var x=0;x<320;++x) {
					soffs4=roffs4;
					cr=cpix[soffs4];
					cg=cpix[soffs4+1];
					cb=cpix[soffs4+2];
					diff=Math.min(255,(Math.abs(cr-opix[soffs4])+Math.abs(cg-opix[soffs4+1])+Math.abs(cb-opix[soffs4+2])));
					v=Math.max(this.scrdiff[offs]*0.9,diff);
					this.scrdiff[offs]=v;
					this.levx[x]+=v;
					this.levy[y]+=v;

					r=cr*t;
					g=cg*t;
					b=cb*t+((cg>128)?255:0)*(1-t);

					switch(this._eff) {
					case 1:
						r+=v;
						break;
					case 2:
						r+=v;
						g+=v;
						b+=v;
						break;
					case 3:
						if(v<20) {
						}
						else if(v<50) {
							b+=v;
						}
						else if(v<100) {
							r+=v;
						}
						else if(v<150) {
							r+=v;
						}
						else if(v<200) {
							r+=v;
							g+=v;
						}
						else {
							r+=v;
							g+=v;
							b+=v;
						}
						break;
					}
					dpix[offs4]=r;
					dpix[offs4+1]=g;
					dpix[offs4+2]=b;
					dpix[offs4+3]=200;
					++offs;
					offs4+=4;
					roffs4-=4;
				}
			}
			for(x=0;x<320;++x)
				avex+=this.levx[x];
			avex/=320;
			for(y=0;y<240;++y)
				avey+=this.levy[y];
			avey/=240;
			px=0;
			for(x=0;x<320;++x) {
				if(this.levx[x]>avex) {
					var d=this.levx[x]-avex;
					px+=x*d;
					sumpx+=d;
					++cntpx;
				}
			}
			if(sumpx)
				px/=sumpx;
			sumpx/=cntpx;
			py=0;
			for(y=0;y<240;++y) {
				if(this.levy[y]>avey) {
					var d=this.levy[y]-avey;
					py+=y*d;
					sumpy+=d;
				}
			}
			if(sumpy)
				py/=sumpy;
			vol=Math.min(1,sumpx*0.0002);
			vol=vol*vol;
			if(vol>0)
				this.curvol=this.curvol*0.8+vol*0.2;
			var r=(this.curvol*15+5);
			var grad=this.ctxcam.createRadialGradient(px|0,(py-r/4)|0,1,px|0,py|0,r|0);
			grad.addColorStop(0,"#fff");
			grad.addColorStop(0.4,"#ff0");
			grad.addColorStop(0.6,"#aa0");
			grad.addColorStop(1,"#000");
			this.ctxcam.putImageData(this.imgdatcam,0,0);
			this.ctxcam.fillStyle=grad;
			this.ctxcam.beginPath();
			this.ctxcam.arc(px,py,r,0,360,0);
			this.ctxcam.fill();

		}
		this.frame^=1;
		this.px=px/320;
		var c;
		c=(this.notes[(px*this.notes.length/320)|0]-57)*100;
		if(this.midi>0) {
			var midiout=midioutputs[this.midi-1];
			if(midiout) {
				if(this.midi!=this._midi) {
					midi.setup(midiout);
					this._midi=this.midi;
				}
				this.Gain.gain.value=0;
				this.midipitch+=(c-this.midipitch)*(1-this.porta);
				var vol=(this.curvol*this.v*127)|0;
				midiout.send([0xb0,7,vol]);
				midiout.send([0x90,69,127]);
				var p=((this.midipitch/1200*8191)|0)+8192;
				midiout.send([0xe0,p&0x7f,(p>>7)&0x7f]);
				var m=(240-py)/240;
				midiout.send([0xb0,70,0]);//detune
				midiout.send([0xb0,80,32]);//cutoff
				midiout.send([0xb0,1,(m*16)|0]);
			}
		}
		else {
			this.Gain.gain.value=this.curvol*this.v*this.gate;
			var f=Math.pow(this._c,((240-py)/240));
			this.Osc.frequency.value=this._f;
			this.Osc.detune.setTargetAtTime(c,0,this.porta*.1);
			this.Fil.frequency.value=this._f*f;
			this.Fil.Q.value=this._q;
			this.LfoGain.gain.value=f*2;
			this.Fil.detune.value=c;
			this.Send.gain.value=this.delay;
		}
		return null;
	}
	function err(err) {
		txt.message("'cam' object is not available.");
	}
	function success(stream) {
		console.log("getUserMedia:success");
		var v=document.getElementById("video");
		v.src= stream;
		v.play();
	}
	function success2(stream) {
		var v=document.getElementById("video");
		v.src= window.URL.createObjectURL(stream);
		v.play();
	}
	if(typeof(navigator.getUserMedia)=="function") {
		console.log("getUserMedia");
		navigator.getUserMedia( {video: true},success,err);
	}
	else if(typeof(navigator.webkitGetUserMedia)=="function") {
		console.log("webkitGetUserMedia");
		navigator.webkitGetUserMedia( {video: true},success2,err);
	}
	else if(typeof(navigator.mozGetUserMedia)=="function") {
		console.log("mozGetUserMedia");
		navigator.mozGetUserMedia( {video: true},success2,err);
	}
	this.imgdatcam=this.ctxcam.createImageData(320,240);
	for(var y=0;y<240;++y) {
		for(var x=0;x<320;++x) {
			this.scrdiff[y*320+x]=0;
		}
	}
	for(var y=0;y<240;++y) {
		for(var x=0;x<320;++x) {
			this.imgdatcam.data[(y*320+x)*4]=0;
			this.imgdatcam.data[(y*320+x)*4+1]=0;
			this.imgdatcam.data[(y*320+x)*4+2]=0;
			this.imgdatcam.data[(y*320+x)*4+3]=255;
		}
	}
}
</script>
<div id="base" style="position:absolute;left:0px;top:0px;background:#000;overflow:hidden">
<canvas id="cvcam" width="320" height="240" style="position:absolute;left:0px;top:0px;height:0px;background:#000"></canvas>
<canvas id="cvwav" width="0" height="0" style="position:absolute;left:0px;top:0px;height:0px"></canvas>
<canvas id="cvwavwork" width="0" height="0" style="position:absolute;left:0px;top:0px;height:0px"></canvas>
</div>
<div id="base2" style="position:absolute;left:0px;top:0px;overflow:hidden">
<canvas id="cvtxt" width="0" height="0" style="position:absolute;left:0px;top:0px;height:0px"></canvas>
<canvas id="cvtxtwork" width="0" height="0" style="position:absolute;left:0px;top:0px;height:0px"></canvas>
</div>
<div id="timecode" style="position:absolute;right:0px;top:0px;width:150px;height:20px;color:#aaa;font-size:20px;font-family:courier">00:00:00:00</div>
<div style="display:none">
	<video id="video" width="320" height="240"></video>
	<canvas id="cvcamwork" width="320" height="240"></canvas>
</div>
</body>
</html>
